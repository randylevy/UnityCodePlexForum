

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" class="" prefix="og: http://ogp.me/ns# profile: http://ogp.me/ns/profile#">
    
    
    
    

    
    <head>
        <meta id="CompatabilityMode" http-equiv="X-UA-Compatible" content="IE=edge" />
	    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link href="../assets/StyleSheet.css" id="MasterCss" rel="stylesheet" type="text/css" />
        <link rel="SHORTCUT ICON" href="../assets/favicon.ico" />
        <title>patterns &#38; practices - Unity - Custom Factory Strategy with ContainerLifetimeManager not working&#63;</title>
        
       
                    <script src="../assets/mscc-0.3.6.min.js"></script>
        
                    <link rel="stylesheet" type="text/css" href="../assets/mscc-0.3.6.min.css" />
        
            <script type="text/javascript">
                var msccHadCookieBannerAtPageStart = true;
            </script>
        

        <!--
        Third party scripts and code linked to or referenced from this website are licensed to you by the parties that own such code,
        not by Microsoft.  See ASP.NET Ajax CDN Terms of Use â€“ http://www.asp.net/ajaxlibrary/CDN.ashx.
        -->
        <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-1.4.4.min.js" type="text/javascript"></script>
        
        <script type="text/javascript">
            if (typeof jQuery === 'undefined') {
                document.write(unescape("%3Cscript src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js' type='text/javascript'%3E%3C/script%3E"));
            }
        </script>

        <script src="https://ajax.aspnetcdn.com/ajax/jquery.ui/1.8.6/jquery-ui.min.js" type="text/javascript"></script>
        
        <script type="text/javascript">
            if (typeof jQuery.ui === 'undefined') {
                document.write(unescape("%3Cscript src='https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.6/jquery-ui.min.js' type='text/javascript'%3E%3C/script%3E"));
            }
        </script>

        
    <style type="text/css">.SideBar, .SideBarPadding{display:none;}.MainContent{width:auto;}.SiteContentTable{width:100%;}</style>
    <style id="ProjectStyles" type="text/css">
        .SiteHeader, .SiteHeaderLeft {
            height:45px !important;
            overflow:hidden;
        }
        .SiteContent 
        {
            padding: 0 0 1em 0;
            margin-top:0;
            min-height:225px;
            border-right: 1px solid lightgrey;
            border-left: 1px solid lightgrey;
            border-bottom: 1px solid lightgrey;
        }
        .IE table.MinWidthContent
        {
	        table-layout: auto !important;	
        }
    </style>
    
    
    <meta name="ROBOTS" content="NOINDEX, NOFOLLOW">

    
    
    <meta id="WTProjectName" name="WT.pi" content="unity"/>
    

    <link rel="EditURI" type="application/rsd+xml" title="RSD" href='http://unity.codeplex.com/rsd' />
    <link rel="wlwmanifest" type="application/wlwmanifest+xml" title="WLWManifest" href='/wlwmanifest.xml' />
    
    
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity" url="http://unity.codeplex.com/project/feeds/rss"/>
    
        
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Discussions" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fforum%2funity"/>
        
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Issues" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fworkitem%2funity"/>
        
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Downloads" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2frelease%2funity"/>
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Reviews" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2freview%2funity"/>
        
    
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Source&#32;code" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fsourcecontrol%2funity"/>
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Wiki" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fwiki%2funity"/>
    
        
    
        <meta content="summary" name="twitter:card" /><meta content="@CodePlex" name="twitter:site" /><meta content="http://unity.codeplex.com/discussions/435999?ProjectName=unity" name="twitter:url" /><meta content="patterns &amp;#38; practices - Unity" name="twitter:title" /><meta content="The Unity Application Block &amp;#40;Unity&amp;#41; is officially under new ownership.&amp;#13;&amp;#10;https&amp;#58;&amp;#47;&amp;#47;github.com&amp;#47;unitycontainer&amp;#47;unity" name="twitter:description" /><meta content="http://www.codeplex.com/Images/codeplex.png" name="twitter:image" /><meta content="CodePlex" property="og:site_name" /><meta content="http://unity.codeplex.com/discussions/435999?ProjectName=unity" property="og:url" /><meta content="object" property="og:type" /><meta content="patterns &amp;#38; practices - Unity" property="og:title" /><meta content="The Unity Application Block &amp;#40;Unity&amp;#41; is officially under new ownership.&amp;#13;&amp;#10;https&amp;#58;&amp;#47;&amp;#47;github.com&amp;#47;unitycontainer&amp;#47;unity" property="og:description" /><meta content="http://www.codeplex.com/Images/codeplex.png" property="og:image" />
        

    </head>
    
    <body>
         
            
        <script src="../assets/ScriptLoader.js" type="text/javascript"></script>
        <form id="aspnetForm" autocomplete="off" method="POST" enctype="multipart/form-data">
            <input name="__RequestVerificationToken" type="hidden" value="GnxdnJ6xiNkrtFYxd-iYcQt8alvKwzv9zXrxIId_rxKqHHFHsSXfpoPN2QGP0es3ais7IA104gyJ4hWcy5aOaiGFumUQ1E9Ly_6l0UTfXBwpEINfUzTavNQb7vk5Yn_RyIfHFA2" /><input name="__RequestVerificationToken2" type="hidden" value="__RequestVerificationToken267a82a1b-dbaf-498d-9553-ed902247390b" />
            
            <div id="UpdateProgressPanel" class="loading_animation" style="display:none;">
                <div class="row">
                    <h2 class="anim_h2">
                        <span id="UpdateProgressText">Updating...</span>
                        <span id="animatedLoadingIconContainer">
                            <img id="animatedLoadingIcon" src="../assets/loading_animation.gif" class="anim_img"/>
                        </span>
                    </h2>
                </div>
            </div>
            
            <div style="display:none;">
                
                <img id="BlankImage" style="width:0;height:0;" src="../assets/blank.png" onload="self.logoImageLoaded=true;"/>

                <script language="javascript" type="text/javascript">
                    var date = new Date();
                    var timezoneOffset = date.getTimezoneOffset() / 60 * -1;
                    var timezoneOffsetCookie = getCookie("TimezoneOffset");
                    var firstTimeSetTimezoneCookie = false;

                    if (timezoneOffsetCookie == null || timezoneOffsetCookie != timezoneOffset) {
                        firstTimeSetTimezoneCookie = true;
                        document.cookie = "TimezoneOffset=" + timezoneOffset + '; domain=.codeplex.com;expires=Wed, 10 Oct 2018 05:25:58 UTC';
                    }
                </script>
            </div>
            
            
            <div id="banner">
                <div id="message"><strong>This is an archived copy of the original CodePlex Unity Discussion Forum</strong><br />Unity is now on <a href="https://github.com/unitycontainer/">GitHub</a>
                    
                </div>
            </div>
            

            <div id="header">
                <div id="header_wrap" class="row">
                    <p id="logo"><a href="http://www.codeplex.com">Code<span class="semi">Plex</span></a><span id="tagline">Project Hosting for Open Source Software</span></p>
                    

<ul id="nav">

    <li><a href="/site/register/new" id="registerLink" class="ZoomFix">Register</a></li>
    <li ><a class="SignInLink" href="https://www.codeplex.com/site/login?RedirectUrl=http%3a%2f%2funity.codeplex.com%2fdiscussions%2f435999" id="signInLink">Sign In</a></li>
  
    <li class="last"><a class="rss_site_icon" href="http://www.codeplex.com/site/feeds/rss" type="application/rss+xml" rel="Alternate" title="CodePlex Site Activity"></a></li>
</ul>
                    <input id="searchsite" name="searchsite" maxlength="500" type="text" value="" /><span id="search_mag"><a id="submitSearch" name="submitSearch" class="magnify" title="Search" href="#"></a></span>
                    <script>
	$(document).ready(function() {
    var searchButton = $('#submitSearch'),
        searchBar = $('#searchsite');

    // Register our own handler for the search event while we wait for the SearchBox script to load.
    searchButton.bind('click.backupSearchBox', doProjectSearch);
    searchBar.bind('keypress.backupSearchBox', function(e) { if ($keyCode(e) === 13) { doProjectSearch(); return false; } });

    function cleanupSearchEvents() {
        // If the SearchBox was loaded, unregister our handlers.
        if (epx_loaded) {
            searchButton.unbind('.backupSearchBox');
            searchBar.unbind('.backupSearchBox');
        }
    }

    $loadScript('https://i4.services.social.microsoft.com/search/Widgets/SearchBox.jss?appid=1000&scopeid=1&boxId=searchsite&btnId=submitSearch&watermark=Search%20all%20projects&overrideWatermark=true&searchLocation=https%3A%2F%2Fwww.codeplex.com%2Fsite%2Fsearch&allowEmptySearch=true&focusOnInit=False&minimumTermLength=3', cleanupSearchEvents);
})
function doProjectSearch() {
    
    var url = 'https://www.codeplex.com/site/search';

    //If search term is not same as watermark
    if($('#searchsite').val() != 'Search all projects')    
    {        
        url = url + '?query=' + encodeURIComponent($('#searchsite').val());
    }

    
    var callback = '';
    if (callback.length > 0 && eval('typeof ' + callback) != 'undefined')
        url += eval(callback + '()');

    window.location.href = url;
    return false;
}
</script>
                </div>
            </div>
            
            <div id="wrap">
                
    <div id="sub_heading" class="row">
        
        <div id="ProjectHeader">
            <div id="project_title_row" class="row">
                <div id="project_logo">
                    
<a id="AffiliateLink" href="http://msdn.microsoft.com/practices">
    <img id="AffiliateImage" src="../assets/pnp_logo.png" title="patterns&#32;&#38;&#32;practices" />
</a>

    
    <h1 class="text_only"><a href="http://unity.codeplex.com/" id="ProjectTitle1"><div>patterns &#38; practices - Unity</div></a></h1>

                </div>
            </div>
        </div>
        
        <div id="ProjectDetailsDiv">
            
        </div>
		<div class="clear"></div>
        

<ul id="page_box_links">
	<li id="homeTabCell" style="width: 63px;"><a id="homeTab" href="http://unity.codeplex.com/" class="box_home">home</a><div></div></li>
    
	<li id="sourceTabCell" style="width:113px;"><a id="sourceTab" href="http://unity.codeplex.com/SourceControl/latest" class="box_source">source code</a><div></div></li>
    
	<li id="releasesTabCell" style="width:105px;"><a id="releasesTab" href="http://unity.codeplex.com/releases" class="box_downloads">downloads</a><div></div></li>
    
    <li id="documentationTabCell" style="width:143px;"><a id="documentationTab" href="http://unity.codeplex.com/documentation" class="box_documentation">documentation</a><div></div></li>
    
	<li id="discussionTabCell" style="width:112px;"><a id="discussionTab" href="../index.html" class="discussions_active">discussions</a><div></div></li>
    
	<li id="workItemsTabCell" style="width:70px;"><a id="workItemsTab" href="http://unity.codeplex.com/workitem/list/basic" class="box_issue">issues</a><div></div></li>
    
	<li id="peopleTabCell" style="width:70px;"><a id="peopleTab" href="http://unity.codeplex.com/team/view" class="box_people">people</a><div></div></li>
	<li id="licenseTabCell" style="width:70px;"><a id="licenseTab" href="http://unity.codeplex.com/license" class="box_license">license</a><div></div></li>
    
    <span class="stretch"></span>
</ul>

<script type="text/javascript">
    $(document).ready(function () {
        $('#page_box_links').applyLastClassToList();
    });
</script>
		    <div class="clear"></div>
            
     <td>
       

<div>
    
    <div id="actionBar" class="action_bar">
        <ul id="actionBar_ul" class="actionBar_sublinks subtab_right" style="vertical-align: middle;">

            

                <li id="li_actionbar_creatediscussion" data-action-id="actionbar_creatediscussion" data-action-type="Navigate" class="actionBar_sublinks" data-options-id="f8df108e-aba8-4cbf-af47-70a9fcc5ddde">
                
                    <script class="options" defer="defer" id="f8df108e-aba8-4cbf-af47-70a9fcc5ddde" type="application/json">{"navigate-url":"http://unity.codeplex.com/discussions/create"}</script> 
                    
                    <div class="actionBar_custom_content"></div>

                    <a href="#" id="actionbar_creatediscussion" title="Start a New Thread" class="action_bar_item_link">
                        <img id="img_actionbar_creatediscussion" class="action_bar_item_image" src="../assets/actionbar_newitem.png" style="vertical-align: middle" />
                        New Thread
                    </a>

                </li>

            

                <li id="li_actionbar_subscribe" data-action-id="actionbar_subscribe" data-action-type="PopUp" class="actionBar_sublinks" data-options-id="9b0a89a6-737b-4091-8de0-612ff774bbf6">
                
                    <script class="options" defer="defer" id="9b0a89a6-737b-4091-8de0-612ff774bbf6" type="application/json">{}</script> 
                    
                    <div class="actionBar_custom_content">

<div id="rssHoverDiv" class="HoverPanel LeftHoverWidth" style="display: none">
        <ul id="3_FeedsPanel" class="RssFeedsPanel">
            <li>
                <a id="ProjectRssLink" href="http://unity.codeplex.com/project/feeds/rss" class="ArrowSmall NoUnderline">All Project Updates</a>
            </li>
            
            <li>
                <a id="DiscussionRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fforum%2funity" class="ArrowSmall NoUnderline">Discussions</a>
            </li>
            
            <li>
                <a id="IssueTrackerRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fworkitem%2funity" class="ArrowSmall NoUnderline">Issue Tracker</a>
            </li>
            
            <li>
                <a id="ReleasesRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2frelease%2funity" class="ArrowSmall NoUnderline">Downloads</a>
            </li>
            <li>
                <a id="ReviewsRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2freview%2funity" class="ArrowSmall NoUnderline">Reviews</a>
            </li>
            
            <li>
                <a id="SourceControlRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fsourcecontrol%2funity" class="ArrowSmall NoUnderline">Source Code</a>
            </li>
            <li>
                <a id="WikiRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fwiki%2funity" class="ArrowSmall NoUnderline">Wiki &amp; Documentation</a>
            </li>
        </ul>
</div></div>

                    <a href="#" id="actionbar_subscribe" title="Subscribe to project updates in RSS feeds." class="action_bar_item_link">
                        <img id="img_actionbar_subscribe" class="action_bar_item_image" src="../assets/actionbar_subscribe.png" style="vertical-align: middle" />
                        Subscribe
                    </a>

                </li>

            
        </ul>
    </div>
</div>
     </td>

        

    </div>
    
    
<div class="Threads">
    <div class="ViewThread">
        
        
        
            <h1 class="page_title WordWrapBreakWord">
                Custom Factory Strategy with ContainerLifetimeManager not working&#63;
            </h1>

            <!-- Private Discussion header -->
            

            <!-- Posts List Header: Topics and Wiki Link -->
            <table class="PostsListHeader">
                <tr>
                    <td>
                     
                    </td>
                    <td>
                        <div class="WikiLink">
                            <span title="Paste this into a wiki page to link to this discussion">
                                Wiki Link: [discussion:435999]
                            </span>
                        </div>
                    </td>
                </tr>
            </table>

            <!-- The list of posts -->
            

<div id="discussionsPostList" data-options-id="2c3959d4-0de1-4cf0-b0a7-94dfd3e788db">
    <script class="options" defer="defer" id="2c3959d4-0de1-4cf0-b0a7-94dfd3e788db" type="application/json">{"threadUrl":"http://unity.codeplex.com/discussions/435999","showEditor":false,"checkImageUrl":"../assets/check_answer.png"}</script>

    <div class="Posts" style="margin-top: 10px;">
    

<table cellpadding="0" cellspacing="0" style="width: 100%; margin-bottom: 0px; table-layout:fixed">
    

<tr id="PostPanel" class="Post" d:forid="1012744">
    <td id="PostDetailsCell_1012744" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post1012744"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/julealgon">julealgon</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="3/9/2013 2:01:50 PM" LocalTimeTicks="1362866510">Mar 9, 2013 at 2:01 PM</span></div>
            
        </div>
    </td>
    <td id="PostContent_1012744" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post markDownOutput" 
        data-markdown="We&#32;have&#32;recently&#32;started&#32;using&#32;the&#32;unity&#32;container&#32;in&#32;our&#32;code&#32;base&#32;as&#32;a&#32;means&#32;to&#32;reduce&#32;our&#32;dependency&#32;management&#32;complexity&#32;and&#32;things&#32;like&#32;that.&#32;Since&#32;our&#32;code&#32;base&#32;is&#32;kind&#32;of&#32;big,&#32;and&#32;very&#32;convoluted&#32;&#40;with&#32;some&#32;very&#32;bad&#32;practices&#32;in&#32;some&#32;places&#41;,&#32;I&#32;have&#32;not&#32;checked&#32;in&#32;the&#32;code&#32;yet,&#32;and&#32;have&#32;been&#32;experimenting&#32;with&#32;ways&#32;to&#32;approach&#32;the&#32;problem&#32;as&#32;to&#32;not&#32;interfere&#32;with&#32;the&#32;rest&#32;of&#32;the&#32;code&#32;&#40;this&#32;will&#32;need&#32;to&#32;be&#32;incremental,&#32;so&#32;I&#39;m&#32;not&#32;adding&#32;DI&#32;to&#32;everything&#32;just&#32;yet,&#32;just&#32;the&#32;basic&#32;structure&#32;and&#32;wiring&#41;.&#13;&#10;&#13;&#10;After&#32;trying&#32;some&#32;things,&#32;I&#32;found&#32;an&#32;excellent&#32;post&#32;on&#32;stackoverflow,&#32;by&#32;Mark&#32;Heath,&#32;about&#32;a&#32;custom&#32;factory&#32;extension&#32;that&#32;would&#32;enable&#32;one&#32;to&#32;pass&#32;in&#32;a&#32;factory&#32;to&#32;create&#32;proxy&#32;remoting&#32;objects&#32;instead&#32;of&#32;concrete&#32;classes.&#13;&#10;&#13;&#10;http&#58;&#47;&#47;stackoverflow.com&#47;questions&#47;1380375&#47;custom-object-factory-extension-for-unity&#13;&#10;&#13;&#10;This&#32;was&#32;very&#32;fit&#32;to&#32;our&#32;reality&#32;as&#32;we&#32;have&#32;a&#32;bunch&#32;of&#32;separate&#32;web&#32;applications&#32;communicating&#32;over&#32;remoting,&#32;so&#32;I&#32;replicated&#32;the&#32;classes&#32;here&#32;and&#32;added&#32;the&#32;extension&#32;to&#32;the&#32;container.&#32;The&#32;problem&#32;I&#39;m&#32;having&#32;with&#32;this&#32;though&#32;is&#32;that&#32;my&#32;factory&#32;is&#32;being&#32;called&#32;every&#32;time&#32;Resolve&#32;is&#32;called&#32;on&#32;the&#32;container.&#32;I&#32;would&#32;expect&#32;it&#32;to&#32;be&#32;called&#32;only&#32;the&#32;first&#32;time,&#32;and&#32;that&#32;after&#32;that,&#32;the&#32;stored&#32;singleton&#32;object&#32;would&#32;be&#32;returned.&#13;&#10;&#13;&#10;My&#32;implementation&#32;is&#32;a&#32;bit&#32;simpler&#32;than&#32;his,&#32;because&#32;I&#39;m&#32;not&#32;worried&#32;about&#32;child&#32;containers&#32;and&#32;stuff&#32;like&#32;that,&#32;so&#32;there&#32;is&#32;no&#32;need&#32;for&#32;the&#32;custom&#32;marker&#32;policy&#32;class&#32;there&#32;and&#32;all&#32;the&#32;extra&#32;handling&#32;on&#32;the&#32;strategy&#32;to&#32;find&#32;the&#32;marker.&#32;&#13;&#10;&#13;&#10;So,&#32;I&#32;basically&#32;substituted&#32;this&#58;&#13;&#10;&#96;&#96;&#96;&#13;&#10;&#47;&#47;&#32;Find&#32;the&#32;container&#32;to&#32;add&#32;this&#32;to&#13;&#10;IPolicyList&#32;parentPolicies&#59;&#13;&#10;var&#32;parentMarker&#32;&#61;&#32;context.Policies.Get&#60;ParentMarkerPolicy&#62;&#40;new&#32;NamedTypeBuildKey&#60;ParentMarkerPolicy&#62;&#40;&#41;,&#32;out&#32;parentPolicies&#41;&#59;&#13;&#10;&#13;&#10;&#47;&#47;&#32;TODO&#58;&#32;add&#32;error&#32;check&#32;-&#32;if&#32;policy&#32;is&#32;missing,&#32;extension&#32;is&#32;misconfigured&#13;&#10;&#13;&#10;&#47;&#47;&#32;Add&#32;lifetime&#32;manager&#32;to&#32;container&#13;&#10;parentPolicies.Set&#60;ILifetimePolicy&#62;&#40;ltm,&#32;new&#32;NamedTypeBuildKey&#40;key.Type&#41;&#41;&#59;&#13;&#10;&#47;&#47;&#32;And&#32;add&#32;to&#32;LifetimeContainer&#32;so&#32;it&#32;gets&#32;disposed&#13;&#10;parentMarker.AddToLifetime&#40;ltm&#41;&#59;&#13;&#10;&#96;&#96;&#96;&#13;&#10;by&#32;this&#58;&#13;&#10;&#96;&#96;&#96;&#13;&#10;context.Policies.Set&#40;ltm,&#32;new&#32;NamedTypebuildKey&#40;key.Type&#41;&#41;&#59;&#13;&#10;&#96;&#96;&#96;&#13;&#10;&#13;&#10;I&#39;m&#32;kind&#32;of&#32;bummed&#32;by&#32;the&#32;fact&#32;that,&#32;when&#32;I&#32;compare&#32;two&#32;instances&#32;returned&#32;by&#32;consecutive&#32;Resolves&#32;&#40;in&#32;the&#32;immediate&#32;window&#32;for&#32;instance&#41;,&#32;they&#32;are&#32;actually&#32;the&#32;same&#32;instance.&#32;It&#39;s&#32;as&#32;if&#32;the&#32;strategy&#32;is&#32;recreating&#32;the&#32;instance&#32;through&#32;the&#32;factory,&#32;but&#32;this&#32;newly&#32;created&#32;instance&#32;is&#32;not&#32;being&#32;returned,&#32;but&#32;the&#32;cached&#32;one.&#32;I&#32;think&#32;that&#32;if&#32;I&#32;just&#32;called&#32;Activator.GetObject&#32;twice&#32;they&#32;would&#32;be&#32;different&#32;instances&#32;right&#63;&#13;&#10;&#13;&#10;As&#32;a&#32;matter&#32;of&#32;fact,&#32;I&#39;m&#32;not&#32;entirely&#32;sure&#32;what&#32;the&#32;whole&#32;code&#32;is&#32;doing&#32;here,&#32;since&#32;I&#39;ve&#32;basically&#32;copied&#32;and&#32;adapted&#32;it.&#32;It&#32;would&#32;be&#32;nice&#32;if&#32;someone&#32;was&#32;able&#32;to&#32;point&#32;me&#32;to&#32;documentation&#32;describing&#32;the&#32;correct&#32;steps&#32;in&#32;implementing&#32;a&#32;custom&#32;extension&#32;and&#32;how&#32;everything&#32;works&#32;together.&#32;I&#32;managed&#32;to&#32;create&#32;a&#32;completely&#32;custom&#32;application&#32;block&#32;in&#32;the&#32;Entlib&#32;by&#32;following&#32;the&#32;tutorial,&#32;but&#32;in&#32;this&#32;case&#32;here&#32;it&#32;is&#32;just&#32;too&#32;hard&#32;to&#32;get&#32;something&#32;working&#32;as&#32;expected&#32;without&#32;knowing&#32;how&#32;the&#32;underlying&#32;mechanics&#32;actually&#32;use&#32;your&#32;classes.&#32;If&#32;I&#32;at&#32;least&#32;knew&#32;what&#32;happened&#32;in&#32;the&#32;life&#32;cycle&#32;of&#32;the&#32;container,&#32;or&#32;the&#32;steps&#32;involved&#32;when&#32;one&#32;requests&#32;an&#32;object&#32;or&#32;a&#32;BuildUp,&#32;and&#32;things&#32;like&#32;that&#32;maybe&#32;I&#32;could&#32;work&#32;out&#32;a&#32;solution&#32;on&#32;my&#32;own.&#13;&#10;&#13;&#10;Even&#32;so,&#32;why&#32;is&#32;this&#32;strategy&#32;being&#32;called&#32;on&#32;every&#32;resolve&#32;for&#32;the&#32;same&#32;object&#63;&#32;How&#32;are&#32;the&#32;strategies&#32;called&#32;anyways&#63;&#32;Does&#32;it&#32;call&#32;every&#32;strategy&#32;in&#32;order&#32;on&#32;the&#32;strategy&#32;chain&#32;in&#32;the&#32;container,&#32;and&#32;stops&#32;on&#32;the&#32;first&#32;one&#32;that&#32;sets&#32;the&#32;BuildComplete&#32;flag&#63;&#32;Maybe&#32;I&#39;m&#32;wiring&#32;this&#32;the&#32;wrong&#32;way&#32;somehow,&#32;and&#32;my&#32;strategy&#32;is&#32;running&#32;earlier&#32;than&#32;it&#32;should&#63;&#32;Am&#32;I&#32;missing&#32;something&#32;else&#32;here&#63;&#13;&#10;&#13;&#10;Regards,&#13;&#10;Juliano&#32;Goncalves">
        <div class="markDownOutput ">We have recently started using the unity container in our code base as a means to reduce our dependency management complexity and things like that. Since our code base is kind of big, and very convoluted (with some very bad practices in some places), I
 have not checked in the code yet, and have been experimenting with ways to approach the problem as to not interfere with the rest of the code (this will need to be incremental, so I'm not adding DI to everything just yet, just the basic structure and wiring).
<br>
<br>
After trying some things, I found an excellent post on stackoverflow, by Mark Heath, about a custom factory extension that would enable one to pass in a factory to create proxy remoting objects instead of concrete classes.
<br>
<br>
<a href="http://stackoverflow.com/questions/1380375/custom-object-factory-extension-for-unity"  rel="nofollow">http://stackoverflow.com/questions/1380375/custom-object-factory-extension-for-unity</a>
<br>
<br>
This was very fit to our reality as we have a bunch of separate web applications communicating over remoting, so I replicated the classes here and added the extension to the container. The problem I'm having with this though is that my factory is being called
 every time Resolve is called on the container. I would expect it to be called only the first time, and that after that, the stored singleton object would be returned.
<br>
<br>
My implementation is a bit simpler than his, because I'm not worried about child containers and stuff like that, so there is no need for the custom marker policy class there and all the extra handling on the strategy to find the marker.
<br>
<br>
So, I basically substituted this:<br>
<pre><code>// Find the container to add this to
IPolicyList parentPolicies;
var parentMarker = context.Policies.Get&lt;ParentMarkerPolicy&gt;(new NamedTypeBuildKey&lt;ParentMarkerPolicy&gt;(), out parentPolicies);

// TODO: add error check - if policy is missing, extension is misconfigured

// Add lifetime manager to container
parentPolicies.Set&lt;ILifetimePolicy&gt;(ltm, new NamedTypeBuildKey(key.Type));
// And add to LifetimeContainer so it gets disposed
parentMarker.AddToLifetime(ltm);</code></pre>
by this:<br>
<pre><code>context.Policies.Set(ltm, new NamedTypebuildKey(key.Type));</code></pre>
I'm kind of bummed by the fact that, when I compare two instances returned by consecutive Resolves (in the immediate window for instance), they are actually the same instance. It's as if the strategy is recreating the instance through the factory, but this
 newly created instance is not being returned, but the cached one. I think that if I just called Activator.GetObject twice they would be different instances right?
<br>
<br>
As a matter of fact, I'm not entirely sure what the whole code is doing here, since I've basically copied and adapted it. It would be nice if someone was able to point me to documentation describing the correct steps in implementing a custom extension and how
 everything works together. I managed to create a completely custom application block in the Entlib by following the tutorial, but in this case here it is just too hard to get something working as expected without knowing how the underlying mechanics actually
 use your classes. If I at least knew what happened in the life cycle of the container, or the steps involved when one requests an object or a BuildUp, and things like that maybe I could work out a solution on my own.
<br>
<br>
Even so, why is this strategy being called on every resolve for the same object? How are the strategies called anyways? Does it call every strategy in order on the strategy chain in the container, and stops on the first one that sets the BuildComplete flag?
 Maybe I'm wiring this the wrong way somehow, and my strategy is running earlier than it should? Am I missing something else here?
<br>
<br>
Regards, <br>
Juliano Goncalves<br>
</div>
        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_1012744" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="1012954">
    <td id="PostDetailsCell_1012954" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post1012954"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/randylevy">randylevy</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="3/10/2013 3:29:49 PM" LocalTimeTicks="1362954589">Mar 10, 2013 at 3:29 PM</span></div>
            
            <div style="white-space: normal" class="SubText" id="UpdatedDiv">Edited <span class="smartDate" title="5/1/2013 8:13:12 PM" LocalTimeTicks="1367464392">May 1, 2013 at 8:13 PM</span></div>
            
        </div>
    </td>
    <td id="PostContent_1012954" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post markDownOutput" 
        data-markdown="Unfortunately,&#32;there&#32;is&#32;no&#32;formal&#32;container&#32;extension&#32;documentation.&#32;&#32;In&#32;the&#32;next&#32;version&#32;of&#32;Enterprise&#32;Library&#32;there&#32;are&#32;&#91;plans&#93;&#40;http&#58;&#47;&#47;entlib.uservoice.com&#47;forums&#47;89245-enterprise-library-6-0-unity-3-0&#47;suggestions&#47;1672393-documentation-for-unity&#41;&#32;to&#32;create&#32;more&#32;documentation&#32;for&#32;the&#32;internals.&#10;&#10;I&#32;think&#32;the&#32;missing&#32;piece&#32;is&#32;that&#32;you&#32;are&#32;not&#32;adding&#32;an&#32;ILifetimePolicy&#32;for&#32;the&#32;build&#32;key&#58;&#10;&#10;So&#32;instead&#32;of&#32;the&#32;one&#32;line&#32;&#10;&#10;&#96;&#96;&#96;&#32;c&#35;&#10;context.Policies.Set&#40;ltm,&#32;new&#32;NamedTypebuildKey&#40;key.Type&#41;&#41;&#59;&#10;&#96;&#96;&#96;&#10;Use&#58;&#10;&#96;&#96;&#96;&#32;c&#35;&#10;&#47;&#47;&#32;Add&#32;lifetime&#32;manager&#32;to&#32;container&#10;context.PersistentPolicies.Set&#60;ILifetimePolicy&#62;&#40;ltm,&#32;new&#32;NamedTypeBuildKey&#40;key.Type&#41;&#41;&#59;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#10;&#47;&#47;&#32;And&#32;add&#32;to&#32;LifetimeContainer&#32;so&#32;it&#32;gets&#32;disposed&#10;context.Lifetime.Add&#40;ltm&#41;&#59;&#10;context.Policies.Set&#40;ltm,&#32;new&#32;NamedTypeBuildKey&#40;key.Type&#41;&#41;&#59;&#10;&#96;&#96;&#96;&#10;&#10;Now&#32;the&#32;ContainerControlledLifetimeManager&#32;will&#32;be&#32;found&#32;for&#32;that&#32;build&#32;key&#32;and&#32;the&#32;current&#32;instance&#32;returned&#32;without&#32;calling&#32;the&#32;container&#32;extension&#32;again.&#32;&#32;&#10;&#10;&#126;&#126;&#10;Randy&#32;Levy&#10;&#91;entlib.support&#64;live.com&#93;&#40;mailto&#58;entlib.support&#64;live.com&#41;&#10;Enterprise&#32;Library&#32;support&#32;engineer&#10;&#91;Support&#32;How-to&#93;&#40;entlib.codeplex.com&#47;wikipage&#63;title&#61;Support&#37;20How-to&#41;&#32;&#10;">
        <div class="markDownOutput ">Unfortunately, there is no formal container extension documentation. In the next version of Enterprise Library there are
<a href="http://entlib.uservoice.com/forums/89245-enterprise-library-6-0-unity-3-0/suggestions/1672393-documentation-for-unity"  rel="nofollow">
plans</a> to create more documentation for the internals.<br>
<br>
I think the missing piece is that you are not adding an ILifetimePolicy for the build key:<br>
<br>
So instead of the one line <br>
<div style="color:Black; background-color:White">
<pre>
context.Policies.Set(ltm, <span style="color:Blue">new</span> NamedTypebuildKey(key.Type));
</pre>
</div>
Use:<br>
<div style="color:Black; background-color:White">
<pre>
<span style="color:Green">// Add lifetime manager to container</span>
context.PersistentPolicies.Set&lt;ILifetimePolicy&gt;(ltm, <span style="color:Blue">new</span> NamedTypeBuildKey(key.Type));
                
<span style="color:Green">// And add to LifetimeContainer so it gets disposed</span>
context.Lifetime.Add(ltm);
context.Policies.Set(ltm, <span style="color:Blue">new</span> NamedTypeBuildKey(key.Type));
</pre>
</div>
Now the ContainerControlledLifetimeManager will be found for that build key and the current instance returned without calling the container extension again.<br>
<br>
~~<br>
Randy Levy<br>
<a href="mailto:entlib.support@live.com" rel="nofollow">&#x65;n&#x74;&#108;&#105;&#x62;&#46;&#115;&#x75;&#112;&#112;&#x6f;&#x72;&#x74;&#x40;&#x6c;&#x69;&#118;&#x65;&#x2e;c&#x6f;&#x6d;</a><br>
Enterprise Library support engineer<br>
<a href="entlib.codeplex.com/wikipage?title=Support%20How-to"  rel="nofollow">Support How-to</a>
<br>
</div>
        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_1012954" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="1013266">
    <td id="PostDetailsCell_1013266" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post1013266"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/julealgon">julealgon</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="3/11/2013 2:16:19 PM" LocalTimeTicks="1363036579">Mar 11, 2013 at 2:16 PM</span></div>
            
        </div>
    </td>
    <td id="PostContent_1013266" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post markDownOutput" 
        data-markdown="Thanks&#32;for&#32;the&#32;info&#32;Randy,&#32;but&#32;it&#32;still&#32;does&#32;not&#32;work.&#32;The&#32;strategy&#32;is&#32;still&#32;being&#32;called&#32;for&#32;the&#32;same&#32;interface&#32;type&#32;everytime&#32;I&#32;call&#32;resolve.&#13;&#10;&#13;&#10;I&#32;was&#32;home&#32;when&#32;I&#32;wrote&#32;the&#32;question,&#32;but&#32;now&#32;I&#32;have&#32;access&#32;to&#32;the&#32;actual&#32;source&#32;code,&#32;so&#32;here&#32;is&#32;the&#32;current&#32;implementation&#58;&#13;&#10;&#13;&#10;&#96;&#96;&#96;&#13;&#10;namespace&#32;&#60;OurCompany&#62;.Framework.Unity&#13;&#10;&#123;&#13;&#10;&#32;&#32;&#32;&#32;using&#32;Microsoft.Practices.ObjectBuilder2&#59;&#13;&#10;&#32;&#32;&#32;&#32;using&#32;Microsoft.Practices.Unity&#59;&#13;&#10;&#13;&#10;&#32;&#32;&#32;&#32;internal&#32;class&#32;CustomFactoryBuildStrategy&#32;&#58;&#32;BuilderStrategy&#13;&#10;&#32;&#32;&#32;&#32;&#123;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;private&#32;readonly&#32;IFactory&#32;m_factory&#59;&#13;&#10;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;public&#32;CustomFactoryBuildStrategy&#40;IFactory&#32;_factory&#41;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#123;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;m_factory&#32;&#61;&#32;_factory&#59;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#125;&#13;&#10;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;public&#32;override&#32;void&#32;PreBuildUp&#40;IBuilderContext&#32;_context&#41;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#123;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;var&#32;key&#32;&#61;&#32;_context.OriginalBuildKey&#59;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;&#40;_context.Existing&#32;&#33;&#61;&#32;null&#32;&#124;&#124;&#32;&#33;m_factory.CanCreate&#40;key.Type&#41;&#41;&#32;return&#59;&#13;&#10;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;_context.Existing&#32;&#61;&#32;m_factory.Create&#40;key.Type&#41;&#59;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;var&#32;ltm&#32;&#61;&#32;new&#32;ContainerControlledLifetimeManager&#40;&#41;&#59;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;ltm.SetValue&#40;_context.Existing&#41;&#59;&#13;&#10;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;_context.PersistentPolicies.Set&#40;ltm,&#32;new&#32;NamedTypeBuildKey&#40;key.Type&#41;&#41;&#59;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;_context.Lifetime.Add&#40;ltm&#41;&#59;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;_context.Policies.Set&#40;ltm,&#32;new&#32;NamedTypeBuildKey&#40;key.Type&#41;&#41;&#59;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;_context.BuildComplete&#32;&#61;&#32;true&#59;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#125;&#13;&#10;&#32;&#32;&#32;&#32;&#125;&#13;&#10;&#125;&#13;&#10;&#96;&#96;&#96;&#13;&#10;&#13;&#10;I&#32;still&#32;don&#39;t&#32;understand&#32;the&#32;actual&#32;differences&#32;on&#32;the&#32;&#34;Policies&#34;&#32;properties.&#32;It&#32;seems&#32;heavily&#32;redundant&#32;to&#32;have&#32;to&#32;add&#32;the&#32;key&#32;to&#32;both&#32;of&#32;them&#32;for&#32;some&#32;reason,&#32;and&#32;I&#39;m&#32;also&#32;not&#32;sure&#32;why&#32;should&#32;I&#32;be&#32;creating&#32;a&#32;new&#32;instance&#32;of&#32;NamedTypeBuildKey&#32;instead&#32;of&#32;just&#32;passing&#32;the&#32;one&#32;I&#32;had&#32;around.&#13;&#10;&#13;&#10;Could&#32;you&#32;perhaps&#32;elaborate&#32;a&#32;bit&#32;on&#32;these&#32;points&#32;too&#63;&#13;&#10;&#13;&#10;Thanks&#32;a&#32;lot&#32;for&#32;the&#32;prompt&#32;help,&#13;&#10;Juliano">
        <div class="markDownOutput ">Thanks for the info Randy, but it still does not work. The strategy is still being called for the same interface type everytime I call resolve.
<br>
<br>
I was home when I wrote the question, but now I have access to the actual source code, so here is the current implementation:<br>
<pre><code>namespace &lt;OurCompany&gt;.Framework.Unity
{
    using Microsoft.Practices.ObjectBuilder2;
    using Microsoft.Practices.Unity;

    internal class CustomFactoryBuildStrategy : BuilderStrategy
    {
        private readonly IFactory m_factory;

        public CustomFactoryBuildStrategy(IFactory _factory)
        {
            m_factory = _factory;
        }

        public override void PreBuildUp(IBuilderContext _context)
        {
            var key = _context.OriginalBuildKey;
            if (_context.Existing != null || !m_factory.CanCreate(key.Type)) return;

            _context.Existing = m_factory.Create(key.Type);
            var ltm = new ContainerControlledLifetimeManager();
            ltm.SetValue(_context.Existing);

            _context.PersistentPolicies.Set(ltm, new NamedTypeBuildKey(key.Type));
            _context.Lifetime.Add(ltm);
            _context.Policies.Set(ltm, new NamedTypeBuildKey(key.Type));
            _context.BuildComplete = true;
        }
    }
}</code></pre>
I still don't understand the actual differences on the &quot;Policies&quot; properties. It seems heavily redundant to have to add the key to both of them for some reason, and I'm also not sure why should I be creating a new instance of NamedTypeBuildKey instead
 of just passing the one I had around. <br>
<br>
Could you perhaps elaborate a bit on these points too? <br>
<br>
Thanks a lot for the prompt help, <br>
Juliano<br>
</div>
        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_1013266" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="1013280">
    <td id="PostDetailsCell_1013280" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post1013280"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/weberse">weberse</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="3/11/2013 2:42:33 PM" LocalTimeTicks="1363038153">Mar 11, 2013 at 2:42 PM</span></div>
            
        </div>
    </td>
    <td id="PostContent_1013280" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post markDownOutput" 
        data-markdown="Another&#32;way&#32;that&#32;completely&#32;bypasses&#32;the&#32;policies&#32;would&#32;be&#32;to&#32;register&#32;the&#32;instance&#32;created&#32;by&#32;your&#32;factory&#32;directly&#32;with&#32;the&#32;container.&#13;&#10;&#13;&#10;&#96;&#96;&#96;&#13;&#10;public&#32;class&#32;CustomFactoryStrategy&#32;&#58;&#32;BuilderStrategy&#13;&#10;&#123;&#13;&#10;&#32;&#32;private&#32;readonly&#32;IFactory&#32;_factory&#59;&#13;&#10;&#13;&#10;&#32;&#32;public&#32;CustomFactoryStrategy&#40;IFactory&#32;factory&#41;&#13;&#10;&#32;&#32;&#123;&#13;&#10;&#32;&#32;&#32;&#32;_factory&#32;&#61;&#32;factory&#59;&#13;&#10;&#32;&#32;&#125;&#13;&#10;&#13;&#10;&#32;&#32;public&#32;override&#32;void&#32;PreBuildUp&#40;IBuilderContext&#32;context&#41;&#13;&#10;&#32;&#32;&#123;&#13;&#10;&#32;&#32;&#32;&#32;NamedTypeBuildKey&#32;key&#32;&#61;&#32;context.OriginalBuildKey&#59;&#13;&#10;&#13;&#10;&#32;&#32;&#32;&#32;if&#32;&#40;context.Existing&#32;&#33;&#61;&#32;null&#32;&#124;&#124;&#32;&#33;_factory.CanCreate&#40;key.Type&#41;&#41;&#13;&#10;&#32;&#32;&#32;&#32;&#123;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;return&#59;&#13;&#10;&#32;&#32;&#32;&#32;&#125;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#13;&#10;&#32;&#32;&#32;&#32;context.Existing&#32;&#61;&#32;_factory.Create&#40;key.Type&#41;&#59;&#13;&#10;&#13;&#10;&#32;&#32;&#32;&#32;var&#32;container&#32;&#61;&#32;context.NewBuildUp&#60;IUnityContainer&#62;&#40;&#41;&#59;&#13;&#10;&#13;&#10;&#32;&#32;&#32;&#32;container.RegisterInstance&#40;key.Type,&#32;key.Name,&#32;context.Existing&#41;&#59;&#13;&#10;&#13;&#10;&#32;&#32;&#32;&#32;context.BuildComplete&#32;&#61;&#32;true&#59;&#13;&#10;&#32;&#32;&#125;&#13;&#10;&#125;&#13;&#10;&#96;&#96;&#96;&#13;&#10;RegisterInstance&#32;uses&#32;the&#32;ContainerControlledLifetimeManager&#32;by&#32;default.&#32;You&#32;just&#32;need&#32;to&#32;specify&#32;Type&#32;and&#32;name&#32;from&#32;the&#32;original&#32;BuildKey">
        <div class="markDownOutput ">Another way that completely bypasses the policies would be to register the instance created by your factory directly with the container.<br>
<pre><code>public class CustomFactoryStrategy : BuilderStrategy
{
  private readonly IFactory _factory;

  public CustomFactoryStrategy(IFactory factory)
  {
    _factory = factory;
  }

  public override void PreBuildUp(IBuilderContext context)
  {
    NamedTypeBuildKey key = context.OriginalBuildKey;

    if (context.Existing != null || !_factory.CanCreate(key.Type))
    {
      return;
    }
      
    context.Existing = _factory.Create(key.Type);

    var container = context.NewBuildUp&lt;IUnityContainer&gt;();

    container.RegisterInstance(key.Type, key.Name, context.Existing);

    context.BuildComplete = true;
  }
}</code></pre>
RegisterInstance uses the ContainerControlledLifetimeManager by default. You just need to specify Type and name from the original BuildKey<br>
</div>
        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_1013280" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="1013289">
    <td id="PostDetailsCell_1013289" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post1013289"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/randylevy">randylevy</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="3/11/2013 3:05:10 PM" LocalTimeTicks="1363039510">Mar 11, 2013 at 3:05 PM</span></div>
            
            <div style="white-space: normal" class="SubText" id="UpdatedDiv">Edited <span class="smartDate" title="5/1/2013 8:13:25 PM" LocalTimeTicks="1367464405">May 1, 2013 at 8:13 PM</span></div>
            
        </div>
    </td>
    <td id="PostContent_1013289" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post markDownOutput" 
        data-markdown="Quick&#32;answer&#58;&#10;&#10;Instead&#32;of&#32;setting&#32;the&#32;policy&#32;like&#32;this&#58;&#10;&#10;&#96;&#96;&#96;&#32;c&#35;&#10;_context.PersistentPolicies.Set&#40;ltm,&#32;new&#32;NamedTypeBuildKey&#40;key.Type&#41;&#41;&#59;&#10;&#96;&#96;&#96;&#10;Set&#32;it&#32;like&#32;this&#58;&#10;&#10;&#96;&#96;&#96;&#32;c&#35;&#10;_context.PersistentPolicies.Set&#60;ILifetimePolicy&#62;&#40;ltm,&#32;new&#32;NamedTypeBuildKey&#40;key.Type&#41;&#41;&#59;&#10;&#96;&#96;&#96;&#10;&#10;In&#32;the&#32;first&#32;code&#32;snippet&#32;the&#32;policy&#32;will&#32;be&#32;inferred&#32;as&#32;ContainerControlledLifeTime&#32;since&#32;that&#32;is&#32;the&#32;type&#32;of&#32;ltm&#32;but&#32;we&#32;really&#32;want&#32;to&#32;explicitly&#32;set&#32;the&#32;ILifetimePolicy.&#10;&#10;&#126;&#126;&#10;Randy&#32;Levy&#10;&#91;entlib.support&#64;live.com&#93;&#40;mailto&#58;entlib.support&#64;live.com&#41;&#10;Enterprise&#32;Library&#32;support&#32;engineer&#10;&#91;Support&#32;How-to&#93;&#40;entlib.codeplex.com&#47;wikipage&#63;title&#61;Support&#37;20How-to&#41;&#32;">
        <div class="markDownOutput ">Quick answer:<br>
<br>
Instead of setting the policy like this:<br>
<div style="color:Black; background-color:White">
<pre>
_context.PersistentPolicies.Set(ltm, <span style="color:Blue">new</span> NamedTypeBuildKey(key.Type));
</pre>
</div>
Set it like this:<br>
<div style="color:Black; background-color:White">
<pre>
_context.PersistentPolicies.Set&lt;ILifetimePolicy&gt;(ltm, <span style="color:Blue">new</span> NamedTypeBuildKey(key.Type));
</pre>
</div>
In the first code snippet the policy will be inferred as ContainerControlledLifeTime since that is the type of ltm but we really want to explicitly set the ILifetimePolicy.<br>
<br>
~~<br>
Randy Levy<br>
<a href="mailto:entlib.support@live.com" rel="nofollow">&#x65;n&#x74;&#108;&#105;&#x62;&#46;&#115;&#x75;&#112;&#112;&#x6f;&#x72;&#x74;&#x40;&#x6c;&#x69;&#118;&#x65;&#x2e;c&#x6f;&#x6d;</a><br>
Enterprise Library support engineer<br>
<a href="entlib.codeplex.com/wikipage?title=Support%20How-to"  rel="nofollow">Support How-to</a>
<br>
</div>
        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_1013289" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="1013323">
    <td id="PostDetailsCell_1013323" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post1013323"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/julealgon">julealgon</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="3/11/2013 3:57:47 PM" LocalTimeTicks="1363042667">Mar 11, 2013 at 3:57 PM</span></div>
            
        </div>
    </td>
    <td id="PostContent_1013323" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post markDownOutput" 
        data-markdown="Wow&#33;&#32;How&#32;unexpected&#33;&#32;&#13;&#10;&#13;&#10;I&#32;thought&#32;the&#32;type&#32;specification&#32;there&#32;was&#32;useless&#32;and&#32;knowingly&#32;removed&#32;it,&#32;because&#32;the&#32;ContainerLifetime&#32;class&#32;already&#32;implemented&#32;the&#32;interface.&#32;It&#32;works&#32;as&#32;expected&#32;now,&#32;awesome&#32;stuff.&#32;&#13;&#10;&#13;&#10;I&#32;would&#32;really&#32;like&#32;to&#32;know&#32;the&#32;why&#39;s&#32;here&#32;though&#32;&#40;the&#32;ones&#32;I&#32;asked&#32;previously&#32;and&#32;now&#32;this&#32;one&#32;too&#41;.&#32;I&#32;see&#32;you&#32;stated&#32;&#34;Quick&#32;answer&#34;&#32;there.&#32;If&#32;you&#32;have&#32;some&#32;free&#32;time&#32;later&#32;on&#32;and&#32;could&#32;either&#32;explain&#32;them&#32;a&#32;bit&#32;or&#32;point&#32;me&#32;somewhere&#32;that&#32;does&#32;I&#32;would&#32;be&#32;very&#32;glad.&#13;&#10;&#13;&#10;Weberse,&#32;I&#32;would&#32;try&#32;your&#32;method&#32;if&#32;Randy&#39;s&#32;correction&#32;did&#32;not&#32;work.&#32;Thanks&#32;a&#32;lot&#32;for&#32;the&#32;input&#32;too.&#32;I&#32;would&#32;actually&#32;like&#32;to&#32;hear&#32;what&#32;the&#32;differences&#32;would&#32;be&#32;if&#32;I&#32;went&#32;with&#32;your&#32;solution&#32;though,&#32;since&#32;it&#32;seems&#32;less&#32;complicated&#32;than&#32;the&#32;other&#32;solution.&#32;Would&#32;there&#32;be&#32;any&#32;drawbacks,&#32;or&#32;would&#32;it&#32;be&#32;just&#32;a&#32;different&#32;way&#32;to&#32;do&#32;the&#32;same&#32;thing&#63;&#13;&#10;&#13;&#10;Thanks&#32;a&#32;lot&#32;to&#32;both&#32;of&#32;you.&#13;&#10;Juliano&#13;&#10;&#13;&#10;">
        <div class="markDownOutput ">Wow! How unexpected! <br>
<br>
I thought the type specification there was useless and knowingly removed it, because the ContainerLifetime class already implemented the interface. It works as expected now, awesome stuff.
<br>
<br>
I would really like to know the why's here though (the ones I asked previously and now this one too). I see you stated &quot;Quick answer&quot; there. If you have some free time later on and could either explain them a bit or point me somewhere that does I
 would be very glad. <br>
<br>
Weberse, I would try your method if Randy's correction did not work. Thanks a lot for the input too. I would actually like to hear what the differences would be if I went with your solution though, since it seems less complicated than the other solution. Would
 there be any drawbacks, or would it be just a different way to do the same thing?
<br>
<br>
Thanks a lot to both of you. <br>
Juliano<br>
</div>
        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_1013323" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="1013780">
    <td id="PostDetailsCell_1013780" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post1013780"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/weberse">weberse</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="3/12/2013 10:09:37 AM" LocalTimeTicks="1363108177">Mar 12, 2013 at 10:09 AM</span></div>
            
        </div>
    </td>
    <td id="PostContent_1013780" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post markDownOutput" 
        data-markdown="_RegisterInstance_&#32;triggers&#32;some&#32;logic&#32;inside&#32;the&#32;_UnityDefaultBehaviorExtension_&#32;that&#32;handles&#32;build&#32;key&#32;and&#32;lifetime&#32;management&#32;for&#32;you.&#32;You&#32;don&#39;t&#32;have&#32;to&#32;figure&#32;out&#32;the&#32;details&#32;of&#32;working&#32;with&#32;the&#32;underlying&#32;policies&#32;yourself.&#13;&#10;&#13;&#10;Btw.&#58;&#32;If&#32;you&#32;inject&#32;the&#32;container&#32;via&#32;constructor&#32;parameter&#32;you&#32;can&#32;remove&#32;the&#32;call&#32;to&#32;_NewBuildUp_&#32;as&#32;well.">
        <div class="markDownOutput "><em>RegisterInstance</em> triggers some logic inside the <em>UnityDefaultBehaviorExtension</em> that handles build key and lifetime management for you. You don't have to figure out the details of working with the underlying policies yourself.
<br>
<br>
Btw.: If you inject the container via constructor parameter you can remove the call to
<em>NewBuildUp</em> as well.<br>
</div>
        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_1013780" class="Options" >
            
        </div>
        
    </td>
</tr>

</table>
    </div>

    
        <div class="StandardMarginTop">
            <a id="SignInToAddCommentLink" href="https://www.codeplex.com/site/login?RedirectUrl=http%3a%2f%2funity.codeplex.com%2fdiscussions%2f435999">
                Sign in to post message or set email notifications
            </a>
        </div>
    


    <div id="PostEditorContainer">
        <a name="editor"></a>
        <div id="Editor" style="display: none;">
            

<div class="MarkdownEditor" data-options-id="e0b25c9b-af10-4719-8d95-78710b93cfc9">
    <script class="options" defer="defer" id="e0b25c9b-af10-4719-8d95-78710b93cfc9" type="application/json">{"maxLength":10000,"styleSheetLocation":""}</script>

    <div class="MarkdownEditorControls">
        <a href="#" tabindex="-1" class="control md_help" title="Markdown Syntax Guide"></a>
        <div class="control md_divider"></div>
        <a href="#" tabindex="-1" class="control md_header" title="Insert Header (CTRL + H)"></a>
        <a href="#" tabindex="-1" class="control md_code" title="Insert Code (CTRL + K)"></a>
        <a href="#" tabindex="-1" class="control md_quote" title="Insert Quote (CTRL + Q)"></a>
        <a href="#" tabindex="-1" class="control md_img" title="Insert Img (CTRL + G)"></a>
        <a href="#" tabindex="-1" class="control md_link" title="Insert Link (CTRL + L)"></a>
        <a href="#" tabindex="-1" class="control md_ulist" title="Unordered List (CTRL + U)"></a>
        <a href="#" tabindex="-1" class="control md_olist" title="Ordered List (CTRL + O)"></a>
        <a href="#" tabindex="-1" class="control md_italics" title="Italic Text (CTRL + I)"></a>
        <a href="#" tabindex="-1" class="control md_bold" title="Bold Text (CTRL + B)"></a>
    </div>

    

<div class="tab_control">
    <!-- Generate the basic HTML for the tabs. -->
    
        <div id="Compose"
              class="tab selected"
              data-custom-header-id=""
              data-tab-contents-id="compose_contents_770daa3c-310b-4ef9-b8b0-94b6fe913599">
            Compose
        </div>
    
        <div id="Preview"
              class="tab "
              data-custom-header-id=""
              data-tab-contents-id="preview_contents_4135d7cf-bedd-42cc-a067-b6b0d16a758a">
            Preview
        </div>
    
    <div class="clear"></div>
</div>


    <div id="compose_contents_770daa3c-310b-4ef9-b8b0-94b6fe913599" class="compose_tab_content">
        <textarea class=" MarkdownEditorDimensions" cols="20" id="MarkdownEditor" name="content" rows="2">
</textarea>
        <div class="ClearBoth"></div>

        <div class="markdownGuide" style="display: none">
            <table>
                <tr>
                    <td class="markdownGuideColumn">
                        <h1>Text Formatting</h1>
                        <div># Header 1</div>
                        <div>## Header 2</div>
                        <br />
                        <div>*italics* (or _italics_)</div>
                        <div>**bold** (or __bold__)</div>
                    </td>
                    <td class="markdownGuideColumn">
                        <h1>Lists</h1>
                        <div>* Unordered List</div>
                        <div>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp * SubItem</div>
                        <br />
                        <div>1. Ordered List</div>
                        <div>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp 1. SubItem</div>
                    </td>
                    <td class="markdownGuideColumn">
                        <h1>Quotes</h1>
                        <div>> Lorem ipsum</div>
                        <div>dolor sitamet </div>
                        <div>non. Lectus at</div>
                        <div>nam nunc...</div>
                    </td>
                    <td class="markdownGuideColumn">
                        <h1>Code</h1>
                        <div>`Inline Code`</div>
                        <br />
                        <div>``` C#</div>
                        <div>if (foo==bar)</div>
                        <div>&nbsp&nbsp&nbsp&nbsp&nbsp&nbspbar++</div>
                        <div>```</div>
                    </td>
                    <td class="markdownGuideColumn">
                        <h1>References</h1>
                        <div>[Link Text](URL)</div>
                        <br />
                        <div>![Image](URL)</div>
                        <br />
                        <a class="Reference" target="_blank" href="http://codeplex.codeplex.com/wikipage?title=Markdown&referringTitle=Documentation">Markdown Reference</a>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div id="preview_contents_4135d7cf-bedd-42cc-a067-b6b0d16a758a" class="preview_tab_content markDownOutput">
        
            <div></div>
        
    </div>
    <div class="clear"></div>
</div>

            
            <div class="row" id="recaptcha_row">
                
<script type="text/javascript">
    $(document).ready(function () {
        $('#recaptcha_reload').attr('src', '../assets/recaptcha_refresh.png');
        $('#recaptcha_switch_audio').attr('src', '../assets/recaptcha_audio.png');
        $('#recaptcha_switch_img').attr('src', '../assets/recaptcha_text.png');
        $('#recaptcha_whatsthis').attr('src', '../assets/recaptcha_help.png');
        $('#recaptcha_area tr:first').attr('height', '35');
    });
</script>

                <div class="clear"></div>
                <span id="ReCaptchaError"></span>
            </div>
            <div style="padding-top: 6px;">
                <input type="button" id="SaveButton" value="Save" class="ok" />
                <input type="button" id="CancelButton" value="Cancel" class="cancel" />
                <div class="clear"></div>
            </div>
        </div>
    </div>
</div>

<div id="DeletePostPanel" class="modal" style="display:none">
    <div class="row">
        <h2>Delete Post <a href="javascript:return false;" class="close">X</a></h2>
    </div>
    <div class="modal_info">
        <p>Are you sure you want to delete this post? You will not be able to recover it later.</p>
        <p class="modal_buttons">
            <input type="button" id="ClosePostCancel" value="Cancel" class="cancel" />
            <input type="button" id="ClosePostOk" value="Delete" class="ok" />
        </p>
        <div class="ClearBoth"></div>
    </div>
</div>
        
            <!-- Email notification / Subscription details -->
            
    </div>
</div>
    
<div id="DeleteThreadPanel" class="modal" style="display:none">
    <div class="row">
        <h2>Delete Thread <a href="javascript:return false;" class="close">X</a></h2>
    </div>
    <div class="modal_info">
        <p>Are you sure you want to delete this thread? You will not be able to recover it later.</p>
        <p class="modal_buttons">
            <input type="button" id="CloseThreadCancel" value="Cancel" class="cancel" />
            <input type="button" id="CloseThreadOk" value="Delete" class="ok" />
        </p>
        <div class="ClearBoth"></div>
    </div>
</div>

<script type="text/javascript" language="javascript">
    $(function () {

        $('#recaptcha_response_field')
            .bind('keypress', function (event) { return $submitKeyPressElement(this, event); });


        if ($('#DeleteThreadLink')) {
            $('#DeleteThreadLink').click(function () {
                OpenDialog('#DeleteThreadPanel', true, '41em');
            });
        }
        
        $('#DeleteThreadPanel #CloseThreadOk').click(function () {
            var url = 'http://unity.codeplex.com/discussions/435999';
            $.ajax({
                url: url,
                type: 'DELETE',
                success: function (x) {
                    location.href = x.RedirectUrl;
                }
            });
        });
    });

    workItemMention = new codeplex.ui.WorkItemMention();
    workItemMention.addLinks(".discussionPost");
</script>


        
        
                
                <div class="clear"></div>
                
                <div id="footer">
                    <div class="row">
                        <hr />
                        <ul>
                            <li>Â© 2006-2017 Microsoft</li>
                            <li><a href="http://www.codeplex.com/site/help">Get Help</a></li>
                            <li><a href="/site/legal/privacy">Privacy Statement</a></li>
                            <li><a href="http://www.codeplex.com/site/legal/terms">Terms of Use</a></li>
                            <li><a href="http://www.codeplex.com/site/legal/conduct">Code of Conduct</a></li>
                            <li><a href="http://developermedia.com/" target="_blank">Advertise With Us</a></li>
                            <li>Version 2017.10.3.21062</li>
                        </ul>
                    </div>
                </div>
            </div>
        </form>
    </body>

</html>