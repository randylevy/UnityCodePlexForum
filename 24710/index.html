

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" class="" prefix="og: http://ogp.me/ns# profile: http://ogp.me/ns/profile#">
    
    
    
    

    
    <head>
        <meta id="CompatabilityMode" http-equiv="X-UA-Compatible" content="IE=edge" />
	    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link href="../assets/StyleSheet.css" id="MasterCss" rel="stylesheet" type="text/css" />
        <link rel="SHORTCUT ICON" href="../assets/favicon.ico" />
        <title>patterns &#38; practices - Unity - ContainerControlledLifetimeManager throws caught exception</title>
        
       
                    <script src="../assets/mscc-0.3.6.min.js"></script>
        
                    <link rel="stylesheet" type="text/css" href="../assets/mscc-0.3.6.min.css" />
        
            <script type="text/javascript">
                var msccHadCookieBannerAtPageStart = true;
            </script>
        

        <!--
        Third party scripts and code linked to or referenced from this website are licensed to you by the parties that own such code,
        not by Microsoft.  See ASP.NET Ajax CDN Terms of Use â€“ http://www.asp.net/ajaxlibrary/CDN.ashx.
        -->
        <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-1.4.4.min.js" type="text/javascript"></script>
        
        <script type="text/javascript">
            if (typeof jQuery === 'undefined') {
                document.write(unescape("%3Cscript src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js' type='text/javascript'%3E%3C/script%3E"));
            }
        </script>

        <script src="https://ajax.aspnetcdn.com/ajax/jquery.ui/1.8.6/jquery-ui.min.js" type="text/javascript"></script>
        
        <script type="text/javascript">
            if (typeof jQuery.ui === 'undefined') {
                document.write(unescape("%3Cscript src='https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.6/jquery-ui.min.js' type='text/javascript'%3E%3C/script%3E"));
            }
        </script>

        
    <style type="text/css">.SideBar, .SideBarPadding{display:none;}.MainContent{width:auto;}.SiteContentTable{width:100%;}</style>
    <style id="ProjectStyles" type="text/css">
        .SiteHeader, .SiteHeaderLeft {
            height:45px !important;
            overflow:hidden;
        }
        .SiteContent 
        {
            padding: 0 0 1em 0;
            margin-top:0;
            min-height:225px;
            border-right: 1px solid lightgrey;
            border-left: 1px solid lightgrey;
            border-bottom: 1px solid lightgrey;
        }
        .IE table.MinWidthContent
        {
	        table-layout: auto !important;	
        }
    </style>
    
    
    <meta name="ROBOTS" content="NOINDEX, NOFOLLOW">

    
    
    <meta id="WTProjectName" name="WT.pi" content="unity"/>
    

    <link rel="EditURI" type="application/rsd+xml" title="RSD" href='http://unity.codeplex.com/rsd' />
    <link rel="wlwmanifest" type="application/wlwmanifest+xml" title="WLWManifest" href='/wlwmanifest.xml' />
    
    
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity" url="http://unity.codeplex.com/project/feeds/rss"/>
    
        
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Discussions" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fforum%2funity"/>
        
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Issues" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fworkitem%2funity"/>
        
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Downloads" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2frelease%2funity"/>
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Reviews" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2freview%2funity"/>
        
    
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Source&#32;code" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fsourcecontrol%2funity"/>
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Wiki" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fwiki%2funity"/>
    
        
    
        <meta content="summary" name="twitter:card" /><meta content="@CodePlex" name="twitter:site" /><meta content="http://unity.codeplex.com/discussions/24710?ProjectName=unity" name="twitter:url" /><meta content="patterns &amp;#38; practices - Unity" name="twitter:title" /><meta content="The Unity Application Block &amp;#40;Unity&amp;#41; is officially under new ownership.&amp;#13;&amp;#10;https&amp;#58;&amp;#47;&amp;#47;github.com&amp;#47;unitycontainer&amp;#47;unity" name="twitter:description" /><meta content="http://www.codeplex.com/Images/codeplex.png" name="twitter:image" /><meta content="CodePlex" property="og:site_name" /><meta content="http://unity.codeplex.com/discussions/24710?ProjectName=unity" property="og:url" /><meta content="object" property="og:type" /><meta content="patterns &amp;#38; practices - Unity" property="og:title" /><meta content="The Unity Application Block &amp;#40;Unity&amp;#41; is officially under new ownership.&amp;#13;&amp;#10;https&amp;#58;&amp;#47;&amp;#47;github.com&amp;#47;unitycontainer&amp;#47;unity" property="og:description" /><meta content="http://www.codeplex.com/Images/codeplex.png" property="og:image" />
        

    </head>
    
    <body>
         
            
        <script src="../assets/ScriptLoader.js" type="text/javascript"></script>
        <form id="aspnetForm" autocomplete="off" method="POST" enctype="multipart/form-data">
            <input name="__RequestVerificationToken" type="hidden" value="HGeybUltfsZn-6K4dRSr23qJQqwzGI-usrZ_hBoGn9cCxouJrDLWbXyY11UdEtWa9cxj9-87s4e1qVhKFCtkM403cE5lPylENyPhW3MAsi8b5dSBQOzOqwNrux9Ys50fnxl8BQ2" /><input name="__RequestVerificationToken2" type="hidden" value="__RequestVerificationToken27adc9244-77ba-419e-8f33-463e609fa3cf" />
            
            <div id="UpdateProgressPanel" class="loading_animation" style="display:none;">
                <div class="row">
                    <h2 class="anim_h2">
                        <span id="UpdateProgressText">Updating...</span>
                        <span id="animatedLoadingIconContainer">
                            <img id="animatedLoadingIcon" src="../assets/loading_animation.gif" class="anim_img"/>
                        </span>
                    </h2>
                </div>
            </div>
            
            <div style="display:none;">
                
                <img id="BlankImage" style="width:0;height:0;" src="../assets/blank.png" onload="self.logoImageLoaded=true;"/>

                <script language="javascript" type="text/javascript">
                    var date = new Date();
                    var timezoneOffset = date.getTimezoneOffset() / 60 * -1;
                    var timezoneOffsetCookie = getCookie("TimezoneOffset");
                    var firstTimeSetTimezoneCookie = false;

                    if (timezoneOffsetCookie == null || timezoneOffsetCookie != timezoneOffset) {
                        firstTimeSetTimezoneCookie = true;
                        document.cookie = "TimezoneOffset=" + timezoneOffset + '; domain=.codeplex.com;expires=Wed, 10 Oct 2018 05:28:24 UTC';
                    }
                </script>
            </div>
            
            
            <div id="banner">
                <div id="message"><strong>This is an archived copy of the original CodePlex Unity Discussion Forum</strong><br />Unity is now on <a href="https://github.com/unitycontainer/">GitHub</a>
                    
                </div>
            </div>
            

            <div id="header">
                <div id="header_wrap" class="row">
                    <p id="logo"><a href="http://www.codeplex.com">Code<span class="semi">Plex</span></a><span id="tagline">Project Hosting for Open Source Software</span></p>
                    

<ul id="nav">

    <li><a href="/site/register/new" id="registerLink" class="ZoomFix">Register</a></li>
    <li ><a class="SignInLink" href="https://www.codeplex.com/site/login?RedirectUrl=http%3a%2f%2funity.codeplex.com%2fdiscussions%2f24710" id="signInLink">Sign In</a></li>
  
    <li class="last"><a class="rss_site_icon" href="http://www.codeplex.com/site/feeds/rss" type="application/rss+xml" rel="Alternate" title="CodePlex Site Activity"></a></li>
</ul>
                    <input id="searchsite" name="searchsite" maxlength="500" type="text" value="" /><span id="search_mag"><a id="submitSearch" name="submitSearch" class="magnify" title="Search" href="#"></a></span>
                    <script>
	$(document).ready(function() {
    var searchButton = $('#submitSearch'),
        searchBar = $('#searchsite');

    // Register our own handler for the search event while we wait for the SearchBox script to load.
    searchButton.bind('click.backupSearchBox', doProjectSearch);
    searchBar.bind('keypress.backupSearchBox', function(e) { if ($keyCode(e) === 13) { doProjectSearch(); return false; } });

    function cleanupSearchEvents() {
        // If the SearchBox was loaded, unregister our handlers.
        if (epx_loaded) {
            searchButton.unbind('.backupSearchBox');
            searchBar.unbind('.backupSearchBox');
        }
    }

    $loadScript('http://i4.services.social.microsoft.com/search/Widgets/SearchBox.jss?appid=1000&scopeid=1&boxId=searchsite&btnId=submitSearch&watermark=Search%20all%20projects&overrideWatermark=true&searchLocation=%2fsite%2fsearch&allowEmptySearch=true&focusOnInit=False&minimumTermLength=3', cleanupSearchEvents);
})
function doProjectSearch() {
    
    var url = '/site/search';

    //If search term is not same as watermark
    if($('#searchsite').val() != 'Search all projects')    
    {        
        url = url + '?query=' + encodeURIComponent($('#searchsite').val());
    }

    
    var callback = '';
    if (callback.length > 0 && eval('typeof ' + callback) != 'undefined')
        url += eval(callback + '()');

    window.location.href = url;
    return false;
}
</script>
                </div>
            </div>
            
            <div id="wrap">
                
    <div id="sub_heading" class="row">
        
        <div id="ProjectHeader">
            <div id="project_title_row" class="row">
                <div id="project_logo">
                    
<a id="AffiliateLink" href="http://msdn.microsoft.com/practices">
    <img id="AffiliateImage" src="../assets/pnp_logo.png" title="patterns&#32;&#38;&#32;practices" />
</a>

    
    <h1 class="text_only"><a href="http://unity.codeplex.com/" id="ProjectTitle1"><div>patterns &#38; practices - Unity</div></a></h1>

                </div>
            </div>
        </div>
        
        <div id="ProjectDetailsDiv">
            
        </div>
		<div class="clear"></div>
        

<ul id="page_box_links">
	<li id="homeTabCell" style="width: 63px;"><a id="homeTab" href="http://unity.codeplex.com/" class="box_home">home</a><div></div></li>
    
	<li id="sourceTabCell" style="width:113px;"><a id="sourceTab" href="http://unity.codeplex.com/SourceControl/latest" class="box_source">source code</a><div></div></li>
    
	<li id="releasesTabCell" style="width:105px;"><a id="releasesTab" href="http://unity.codeplex.com/releases" class="box_downloads">downloads</a><div></div></li>
    
    <li id="documentationTabCell" style="width:143px;"><a id="documentationTab" href="http://unity.codeplex.com/documentation" class="box_documentation">documentation</a><div></div></li>
    
	<li id="discussionTabCell" style="width:112px;"><a id="discussionTab" href="../index.html" class="discussions_active">discussions</a><div></div></li>
    
	<li id="workItemsTabCell" style="width:70px;"><a id="workItemsTab" href="http://unity.codeplex.com/workitem/list/basic" class="box_issue">issues</a><div></div></li>
    
	<li id="peopleTabCell" style="width:70px;"><a id="peopleTab" href="http://unity.codeplex.com/team/view" class="box_people">people</a><div></div></li>
	<li id="licenseTabCell" style="width:70px;"><a id="licenseTab" href="http://unity.codeplex.com/license" class="box_license">license</a><div></div></li>
    
    <span class="stretch"></span>
</ul>

<script type="text/javascript">
    $(document).ready(function () {
        $('#page_box_links').applyLastClassToList();
    });
</script>
		    <div class="clear"></div>
            
     <td>
       

<div>
    
    <div id="actionBar" class="action_bar">
        <ul id="actionBar_ul" class="actionBar_sublinks subtab_right" style="vertical-align: middle;">

            

                <li id="li_actionbar_creatediscussion" data-action-id="actionbar_creatediscussion" data-action-type="Navigate" class="actionBar_sublinks" data-options-id="65956b10-00cd-4190-ba7b-83555a939dab">
                
                    <script class="options" defer="defer" id="65956b10-00cd-4190-ba7b-83555a939dab" type="application/json">{"navigate-url":"http://unity.codeplex.com/discussions/create"}</script> 
                    
                    <div class="actionBar_custom_content"></div>

                    <a href="#" id="actionbar_creatediscussion" title="Start a New Thread" class="action_bar_item_link">
                        <img id="img_actionbar_creatediscussion" class="action_bar_item_image" src="../assets/actionbar_newitem.png" style="vertical-align: middle" />
                        New Thread
                    </a>

                </li>

            

                <li id="li_actionbar_subscribe" data-action-id="actionbar_subscribe" data-action-type="PopUp" class="actionBar_sublinks" data-options-id="d0eb228b-f498-4696-84c3-e29f75fcc97d">
                
                    <script class="options" defer="defer" id="d0eb228b-f498-4696-84c3-e29f75fcc97d" type="application/json">{}</script> 
                    
                    <div class="actionBar_custom_content">

<div id="rssHoverDiv" class="HoverPanel LeftHoverWidth" style="display: none">
        <ul id="3_FeedsPanel" class="RssFeedsPanel">
            <li>
                <a id="ProjectRssLink" href="http://unity.codeplex.com/project/feeds/rss" class="ArrowSmall NoUnderline">All Project Updates</a>
            </li>
            
            <li>
                <a id="DiscussionRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fforum%2funity" class="ArrowSmall NoUnderline">Discussions</a>
            </li>
            
            <li>
                <a id="IssueTrackerRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fworkitem%2funity" class="ArrowSmall NoUnderline">Issue Tracker</a>
            </li>
            
            <li>
                <a id="ReleasesRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2frelease%2funity" class="ArrowSmall NoUnderline">Downloads</a>
            </li>
            <li>
                <a id="ReviewsRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2freview%2funity" class="ArrowSmall NoUnderline">Reviews</a>
            </li>
            
            <li>
                <a id="SourceControlRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fsourcecontrol%2funity" class="ArrowSmall NoUnderline">Source Code</a>
            </li>
            <li>
                <a id="WikiRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fwiki%2funity" class="ArrowSmall NoUnderline">Wiki &amp; Documentation</a>
            </li>
        </ul>
</div></div>

                    <a href="#" id="actionbar_subscribe" title="Subscribe to project updates in RSS feeds." class="action_bar_item_link">
                        <img id="img_actionbar_subscribe" class="action_bar_item_image" src="../assets/actionbar_subscribe.png" style="vertical-align: middle" />
                        Subscribe
                    </a>

                </li>

            
        </ul>
    </div>
</div>
     </td>

        

    </div>
    
    
<div class="Threads">
    <div class="ViewThread">
        
        
        
            <h1 class="page_title WordWrapBreakWord">
                ContainerControlledLifetimeManager throws caught exception
            </h1>

            <!-- Private Discussion header -->
            

            <!-- Posts List Header: Topics and Wiki Link -->
            <table class="PostsListHeader">
                <tr>
                    <td>
                     
                    </td>
                    <td>
                        <div class="WikiLink">
                            <span title="Paste this into a wiki page to link to this discussion">
                                Wiki Link: [discussion:24710]
                            </span>
                        </div>
                    </td>
                </tr>
            </table>

            <!-- The list of posts -->
            

<div id="discussionsPostList" data-options-id="c7a961c1-f458-46c6-a3fa-8f21859a3f76">
    <script class="options" defer="defer" id="c7a961c1-f458-46c6-a3fa-8f21859a3f76" type="application/json">{"threadUrl":"http://unity.codeplex.com/discussions/24710","showEditor":false,"checkImageUrl":"../assets/check_answer.png"}</script>

    <div class="Posts" style="margin-top: 10px;">
    

<table cellpadding="0" cellspacing="0" style="width: 100%; margin-bottom: 0px; table-layout:fixed">
    

<tr id="PostPanel" class="Post" d:forid="82843">
    <td id="PostDetailsCell_82843" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post82843"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/francois_tanguay">francois_tanguay</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="3/26/2008 12:21:56 AM" LocalTimeTicks="1206516116">Mar 26, 2008 at 12:21 AM</span></div>
            
        </div>
    </td>
    <td id="PostContent_82843" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post " 
        data-markdown="&#32;Everytime&#32;I&#32;register&#32;an&#32;instance,&#32;in&#32;debug&#32;mode,&#32;I&#39;ll&#32;get&#32;a&#32;SynchronizationLockException&#32;which&#32;is&#32;internally&#32;caught.It&#32;can&#32;get&#32;really&#32;annoying&#32;when&#32;debugging.The&#32;exception&#32;occurs&#32;in&#32;ContainerControlledLifetimeManager.TryExit&#32;due&#32;to&#32;a&#32;call&#32;to&#32;SetValue.I&#39;m&#32;trying&#32;to&#32;figure&#32;out&#32;what&#32;synchronization&#32;does&#32;in&#32;this&#32;class&#32;and&#32;why&#32;it&#32;was&#32;needed&#32;but&#32;can&#39;t&#32;figure&#32;it&#32;out.Any&#32;ways&#32;to&#32;improve&#32;the&#32;experience&#32;so&#32;the&#32;exception&#32;wouldn&#39;t&#32;be&#32;thrown&#63;">
        Everytime I register an instance, in debug mode, I'll get a SynchronizationLockException which is internally caught.<br>
<br>
It can get really annoying when debugging.<br>
<br>
The exception occurs in ContainerControlledLifetimeManager.TryExit due to a call to SetValue.<br>
<br>
I'm trying to figure out what synchronization does in this class and why it was needed but can't figure it out.<br>
<br>
Any ways to improve the experience so the exception wouldn't be thrown?<br>

        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_82843" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="82849">
    <td id="PostDetailsCell_82849" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post82849"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/ctavares">ctavares</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="3/26/2008 12:36:54 AM" LocalTimeTicks="1206517014">Mar 26, 2008 at 12:36 AM</span></div>
            
        </div>
    </td>
    <td id="PostContent_82849" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post " 
        data-markdown="&#32;The&#32;synchronization&#32;is&#32;needed&#32;to&#32;support&#32;proper&#32;thread&#32;safety&#32;when&#32;doing&#32;multi-threaded&#32;buildups&#32;on&#32;a&#32;container&#32;controlled&#32;object.&#32;If&#32;thread&#32;A&#32;starts&#32;building&#32;a&#32;container&#32;controlled&#32;object,&#32;then&#32;swaps&#32;to&#32;thread&#32;B,&#32;which&#32;tries&#32;to&#32;build&#32;the&#32;same&#32;type,&#32;without&#32;the&#32;synchronization&#32;you&#32;could&#32;end&#32;up&#32;building&#32;two&#32;instances&#32;of&#32;the&#32;same&#32;&#34;singleton&#34;&#32;type.&#32;Trust&#32;me,&#32;the&#32;synchronization&#32;is&#32;needed.The&#32;down&#32;side&#32;is&#32;that&#32;there&#32;are&#32;cases&#32;&#40;like&#32;when&#32;registering&#32;an&#32;instance&#41;&#32;where&#32;we&#32;just&#32;call&#32;SetValue.&#32;In&#32;those&#32;cases,&#32;we&#32;don&#39;t&#32;have&#32;the&#32;lock.&#32;There&#39;s&#32;no&#32;TryExitMonitor&#32;method,&#32;so&#32;the&#32;best&#32;we&#32;can&#32;do&#32;is&#32;attempt&#32;to&#32;leave&#32;the&#32;monitor,&#32;and&#32;catch&#32;the&#32;error&#32;if&#32;we&#32;weren&#39;t&#32;actually&#32;holding&#32;the&#32;lock.Since&#32;the&#32;exception&#32;is&#32;actually&#32;being&#32;handled,&#32;the&#32;easiest&#32;thing&#32;to&#32;do&#32;would&#32;be&#32;to&#32;turn&#32;off&#32;&#34;first&#32;chance&#32;exceptions&#34;&#32;for&#32;SynchronizationLockException.&#32;Then&#32;the&#32;debugger&#32;won&#39;t&#32;stop&#32;anymore&#32;unless&#32;the&#32;exception&#32;is&#32;unhandled.If&#32;there&#39;s&#32;some&#32;magic&#32;attribute&#32;or&#32;something&#32;I&#32;can&#32;sprinkle&#32;in&#32;there&#32;to&#32;tell&#32;the&#32;debugger&#32;not&#32;to&#32;break,&#32;I&#39;d&#32;love&#32;to&#32;know&#32;about&#32;it.&#32;Anyone&#32;got&#32;any&#32;ideas&#63;">
        The synchronization is needed to support proper thread safety when doing multi-threaded buildups on a container controlled object. If thread A starts building a container controlled object, then swaps to thread B, which tries to build the same type, without
 the synchronization you could end up building two instances of the same &quot;singleton&quot; type. Trust me, the synchronization is needed.<br>
<br>
The down side is that there are cases (like when registering an instance) where we just call SetValue. In those cases, we don't have the lock. There's no TryExitMonitor method, so the best we can do is attempt to leave the monitor, and catch the error if we
 weren't actually holding the lock.<br>
<br>
Since the exception is actually being handled, the easiest thing to do would be to turn off &quot;first chance exceptions&quot; for SynchronizationLockException. Then the debugger won't stop anymore unless the exception is unhandled.<br>
<br>
If there's some magic attribute or something I can sprinkle in there to tell the debugger not to break, I'd love to know about it. Anyone got any ideas?<br>

        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_82849" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="82856">
    <td id="PostDetailsCell_82856" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post82856"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/francois_tanguay">francois_tanguay</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="3/26/2008 1:18:51 AM" LocalTimeTicks="1206519531">Mar 26, 2008 at 1:18 AM</span></div>
            
        </div>
    </td>
    <td id="PostContent_82856" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post " 
        data-markdown="&#32;I&#32;think&#32;one&#32;of&#32;the&#32;problems&#32;you&#39;re&#32;having&#32;with&#32;synchronization&#32;depends&#32;on&#32;how&#32;the&#32;ILifetimePolicy&#32;is&#32;defined.If&#32;you&#32;were&#32;to&#32;change&#32;the&#32;interface&#32;slightly&#32;for&#32;something&#32;like&#58;&#32;public&#32;interface&#32;ILifetimePolicy&#32;&#123;&#32;object&#32;FindOrCreateValue&#40;Func&#38;lt&#59;object&#38;gt&#59;&#32;factory&#41;&#59;&#32;void&#32;SetValue&#40;object&#32;newValue&#41;&#59;&#32;void&#32;RemoveValue&#40;&#41;&#59;&#32;&#125;&#32;Then&#32;you&#32;give&#32;FindOrCreateValue&#40;...&#41;&#32;a&#32;sufficient&#32;atomic&#32;scope&#32;to&#32;deal&#32;with&#32;synchronization.Then&#32;the&#32;LifeTimeStrategy&#32;could&#32;call&#32;FIndOrCreateValue&#32;instead&#32;of&#32;calling&#32;seperately&#32;GetValue&#47;SetValueAnyways...&#32;I&#39;ll&#32;look&#32;more&#32;into&#32;in&#32;it&#32;again&#32;as&#32;I&#32;tend&#32;to&#32;find&#32;that&#32;this&#32;synchronization&#32;&#43;&#32;InUse&#32;flag&#32;start&#32;smelling&#32;a&#32;bit...Thoughts&#63;">
        I think one of the problems you're having with synchronization depends on how the ILifetimePolicy is defined.<br>
<br>
If you were to change the interface slightly for something like:<br>
<br>
<pre style="background-color:#ECECEC; border:dashed .1em #3E62A6; font-family:Consolas,Courier New,Courier,Monospace; font-size:1em; margin-top:0; padding:.5em; height:auto; overflow:auto; overflow-x:auto; overflow-y:auto">
public interface ILifetimePolicy
{
  object FindOrCreateValue(Func&lt;object&gt; factory);
  void SetValue(object newValue);
  void RemoveValue();
}
</pre>
<br>
Then you give FindOrCreateValue(...) a sufficient atomic scope to deal with synchronization.<br>
<br>
Then the LifeTimeStrategy could call FIndOrCreateValue instead of calling seperately GetValue/SetValue<br>
<br>
Anyways... I'll look more into in it again as I tend to find that this synchronization &#43; InUse flag start smelling a bit...<br>
<br>
Thoughts?<br>

        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_82856" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="82876">
    <td id="PostDetailsCell_82876" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post82876"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/ctavares">ctavares</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="3/26/2008 4:53:39 AM" LocalTimeTicks="1206532419">Mar 26, 2008 at 4:53 AM</span></div>
            
        </div>
    </td>
    <td id="PostContent_82876" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post " 
        data-markdown="&#32;The&#32;InUse&#32;flag&#32;is&#32;there&#32;to&#32;prevent&#32;a&#32;bug&#32;that&#32;one&#32;of&#32;our&#32;product&#32;managers&#32;did&#32;-&#32;he&#32;reused&#32;the&#32;same&#32;lifetime&#32;manager&#32;instance&#32;to&#32;register&#32;three&#32;different&#32;instances,&#32;and&#32;hilarity&#32;ensued.&#32;Since&#32;the&#32;error&#32;he&#32;got&#32;&#40;Entry&#32;point&#32;not&#32;found&#41;&#32;didn&#39;t&#32;obviously&#32;point&#32;to&#32;the&#32;issue,&#32;the&#32;flag&#32;was&#32;added&#32;to&#32;cause&#32;an&#32;understandable&#32;exception&#32;as&#32;early&#32;as&#32;possible.I&#32;don&#39;t&#32;see&#32;how&#32;FindOrCreateValue&#32;would&#32;work&#32;in&#32;the&#32;presence&#32;of&#32;the&#32;current&#32;strategy&#32;chain&#32;execution.&#32;If&#32;you&#39;ve&#32;got&#32;an&#32;idea&#32;&#40;or&#32;a&#32;working&#32;prototype&#41;&#32;I&#39;d&#32;love&#32;to&#32;see&#32;it.">
        The InUse flag is there to prevent a bug that one of our product managers did - he reused the same lifetime manager instance to register three different instances, and hilarity ensued. Since the error he got (Entry point not found) didn't obviously point
 to the issue, the flag was added to cause an understandable exception as early as possible.<br>
<br>
I don't see how FindOrCreateValue would work in the presence of the current strategy chain execution. If you've got an idea (or a working prototype) I'd love to see it.<br>

        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_82876" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="82882">
    <td id="PostDetailsCell_82882" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post82882"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/francois_tanguay">francois_tanguay</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="3/26/2008 5:57:21 AM" LocalTimeTicks="1206536241">Mar 26, 2008 at 5:57 AM</span></div>
            
        </div>
    </td>
    <td id="PostContent_82882" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post " 
        data-markdown="&#32;I&#32;looked&#32;at&#32;this&#32;before&#32;posting&#32;and&#32;my&#32;brain&#32;told&#32;me&#32;I&#32;had&#32;this&#32;part&#32;figured&#32;out...&#32;Look&#32;like&#32;he&#32;was&#32;wrong&#32;&#59;&#41;I&#32;think&#32;that&#32;if&#32;you&#32;implement&#32;ContainerControlledLifetimeManager&#32;using&#32;ReaderWriterLock,&#32;it&#32;would&#32;solve&#32;the&#32;problem.And&#32;I&#32;just&#32;figured&#32;out&#32;what&#32;bothered&#32;me&#32;&#40;smell&#41;&#58;&#32;By&#32;trying&#32;to&#32;make&#32;ContainerControlledLifetimeManager&#32;thread-safe,&#32;you&#32;assumed&#32;the&#32;caller&#32;contract&#32;to&#32;be&#32;that&#32;GetValue&#40;&#41;&#32;would&#32;always&#32;be&#32;called&#32;before&#32;SetValue&#40;&#41;&#32;which&#32;is&#32;obviously&#32;not&#32;the&#32;case.You&#32;also&#32;assumed&#32;that&#32;if&#32;GetValue&#32;was&#32;called&#32;and&#32;value&#32;was&#32;null,&#32;that&#32;SetValue&#32;would&#32;necessarily&#32;be&#32;called.&#32;That&#32;builds&#32;a&#32;lot&#32;of&#32;coupling&#32;between&#32;LifetimeManager&#32;and&#32;LifetimeStrategy.On&#32;a&#32;side&#32;note,&#32;that&#39;s&#32;my&#32;3rd&#32;flag&#32;regarding&#32;the&#32;new&#32;strategy&#32;chain&#32;revamp&#32;where&#32;we&#32;&#34;lose&#34;&#32;context&#32;between&#32;the&#32;pre&#32;and&#32;post&#32;buildup&#32;steps.&#32;Given&#32;the&#32;old&#32;chain,&#32;FindOrCreate&#32;would&#32;have&#32;worked&#58;&#32;object&#32;BuildUp&#40;...&#41;&#32;&#123;&#32;...&#32;if&#32;&#40;existing&#32;&#61;&#61;&#32;null&#41;&#32;&#123;&#32;existing&#32;&#61;&#32;policy.FindOrCreate&#40;&#40;&#41;&#32;&#61;&#38;gt&#59;&#32;base.BuildUp&#40;...&#41;&#41;&#59;&#32;&#125;&#32;...&#32;&#125;&#32;">
        I looked at this before posting and my brain told me I had this part figured out... Look like he was wrong ;)<br>
<br>
I think that if you implement ContainerControlledLifetimeManager using ReaderWriterLock, it would solve the problem.<br>
<br>
And I just figured out what bothered me (smell): By trying to make ContainerControlledLifetimeManager thread-safe, you assumed the caller contract to be that GetValue() would always be called before SetValue() which is obviously not the case.<br>
<br>
You also assumed that if GetValue was called and value was null, that SetValue would necessarily be called. That builds a lot of coupling between LifetimeManager and LifetimeStrategy.<br>
<br>
On a side note, that's my 3rd flag regarding the new strategy chain revamp where we &quot;lose&quot; context between the pre and post buildup steps. Given the old chain, FindOrCreate would have worked:<br>
<pre style="background-color:#ECECEC; border:dashed .1em #3E62A6; font-family:Consolas,Courier New,Courier,Monospace; font-size:1em; margin-top:0; padding:.5em; height:auto; overflow:auto; overflow-x:auto; overflow-y:auto">
object BuildUp(...)
{
...
if (existing == null)
{
  existing = policy.FindOrCreate(() =&gt; base.BuildUp(...));
}
...
}
</pre>

        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_82882" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="143167">
    <td id="PostDetailsCell_143167" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post143167"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/RichardFisk">RichardFisk</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="12/28/2008 5:00:16 AM" LocalTimeTicks="1230469216">Dec 28, 2008 at 5:00 AM</span></div>
            
            <div style="white-space: normal" class="SubText" id="UpdatedDiv">Edited <span class="smartDate" title="3/24/2009 1:02:35 AM" LocalTimeTicks="1237881755">Mar 24, 2009 at 1:02 AM</span></div>
            
        </div>
    </td>
    <td id="PostContent_143167" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post " 
        data-markdown="Whilst&#32;using&#32;Unity&#32;I&#32;had&#32;the&#32;same&#32;issue&#32;of&#32;&#38;quot&#59;in&#32;debug&#32;mode,&#32;I&#39;ll&#32;get&#32;a&#32;SynchronizationLockException&#32;which&#32;is&#32;internally&#32;caught&#38;quot&#59;&#32;so&#32;I&#32;thought&#32;it&#32;might&#32;be&#32;useful&#32;to&#32;post&#32;a&#32;full&#32;solution&#32;that&#32;other&#32;people&#32;could&#32;use.&#32;&#32;&#38;gt&#59;&#32;You&#32;also&#32;assumed&#32;that&#32;if&#32;GetValue&#32;was&#32;called&#32;and&#32;value&#32;was&#32;null,&#32;that&#32;SetValue&#32;would&#32;necessarily&#32;be&#32;called.&#32;&#32;If&#32;SetValue&#32;is&#32;called&#32;without&#32;GetValue&#32;being&#32;called&#32;then&#32;a&#32;subtly&#32;different&#32;but&#32;simpler&#32;solution&#32;would&#32;be&#32;to&#32;set&#32;a&#32;boolean&#32;variable&#32;after&#32;entering&#32;the&#32;monitor&#32;so&#32;that&#32;upon&#32;exiting&#32;this&#32;value&#32;can&#32;be&#32;checked&#32;before&#32;exiting&#58;&#32;&#32;public&#32;abstract&#32;class&#32;SynchronizedLifetimeManager&#32;&#58;&#32;LifetimeManager,&#32;IRequiresRecovery&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#123;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;private&#32;object&#32;lockObj&#32;&#61;&#32;new&#32;object&#40;&#41;&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;private&#32;volatile&#32;bool&#32;hasMonitorEntered&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;summary&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;Retrieve&#32;a&#32;value&#32;from&#32;the&#32;backing&#32;store&#32;associated&#32;with&#32;this&#32;Lifetime&#32;policy.&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;&#47;summary&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;returns&#38;gt&#59;the&#32;object&#32;desired,&#32;or&#32;null&#32;if&#32;no&#32;such&#32;object&#32;is&#32;currently&#32;stored.&#38;lt&#59;&#47;returns&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;remarks&#38;gt&#59;Calls&#32;to&#32;this&#32;method&#32;acquire&#32;a&#32;lock&#32;which&#32;is&#32;released&#32;only&#32;if&#32;a&#32;non-null&#32;value&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;has&#32;been&#32;set&#32;for&#32;the&#32;lifetime&#32;manager.&#38;lt&#59;&#47;remarks&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;public&#32;override&#32;object&#32;GetValue&#40;&#41;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#123;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;Monitor.Enter&#40;lockObj&#41;&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;hasMonitorEntered&#32;&#61;&#32;true&#59;&#47;&#47;inside&#32;of&#32;synchronised&#32;section&#32;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;object&#32;result&#32;&#61;&#32;SynchronizedGetValue&#40;&#41;&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;if&#32;&#40;result&#32;&#33;&#61;&#32;null&#41;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#123;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;Monitor.Exit&#40;lockObj&#41;&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#125;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;return&#32;result&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#125;&#32;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;summary&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;Performs&#32;the&#32;actual&#32;retrieval&#32;of&#32;a&#32;value&#32;from&#32;the&#32;backing&#32;store&#32;associated&#32;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;with&#32;this&#32;Lifetime&#32;policy.&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;&#47;summary&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;returns&#38;gt&#59;the&#32;object&#32;desired,&#32;or&#32;null&#32;if&#32;no&#32;such&#32;object&#32;is&#32;currently&#32;stored.&#38;lt&#59;&#47;returns&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;remarks&#38;gt&#59;This&#32;method&#32;is&#32;invoked&#32;by&#32;&#38;lt&#59;see&#32;cref&#61;&#38;quot&#59;SynchronizedLifetimeManager.GetValue&#38;quot&#59;&#47;&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;after&#32;it&#32;has&#32;acquired&#32;its&#32;lock.&#38;lt&#59;&#47;remarks&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;protected&#32;abstract&#32;object&#32;SynchronizedGetValue&#40;&#41;&#59;&#32;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;summary&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;Stores&#32;the&#32;given&#32;value&#32;into&#32;backing&#32;store&#32;for&#32;retrieval&#32;later.&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;&#47;summary&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;param&#32;name&#61;&#38;quot&#59;newValue&#38;quot&#59;&#38;gt&#59;The&#32;object&#32;being&#32;stored.&#38;lt&#59;&#47;param&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;remarks&#38;gt&#59;Setting&#32;a&#32;value&#32;will&#32;attempt&#32;to&#32;release&#32;the&#32;lock&#32;acquired&#32;by&#32;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;see&#32;cref&#61;&#38;quot&#59;SynchronizedLifetimeManager.GetValue&#38;quot&#59;&#47;&#38;gt&#59;.&#38;lt&#59;&#47;remarks&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;public&#32;override&#32;void&#32;SetValue&#40;object&#32;newValue&#41;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#123;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;SynchronizedSetValue&#40;newValue&#41;&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;TryExit&#40;&#41;&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#125;&#32;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;summary&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;Performs&#32;the&#32;actual&#32;storage&#32;of&#32;the&#32;given&#32;value&#32;into&#32;backing&#32;store&#32;for&#32;retrieval&#32;later.&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;&#47;summary&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;param&#32;name&#61;&#38;quot&#59;newValue&#38;quot&#59;&#38;gt&#59;The&#32;object&#32;being&#32;stored.&#38;lt&#59;&#47;param&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;remarks&#38;gt&#59;This&#32;method&#32;is&#32;invoked&#32;by&#32;&#38;lt&#59;see&#32;cref&#61;&#38;quot&#59;SynchronizedLifetimeManager.SetValue&#38;quot&#59;&#47;&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;before&#32;releasing&#32;its&#32;lock.&#38;lt&#59;&#47;remarks&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;protected&#32;abstract&#32;void&#32;SynchronizedSetValue&#40;object&#32;newValue&#41;&#59;&#32;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;summary&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;Remove&#32;the&#32;given&#32;object&#32;from&#32;backing&#32;store.&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;&#47;summary&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;public&#32;override&#32;void&#32;RemoveValue&#40;&#41;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#123;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#125;&#32;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;summary&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;A&#32;method&#32;that&#32;does&#32;whatever&#32;is&#32;needed&#32;to&#32;clean&#32;up&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;as&#32;part&#32;of&#32;cleaning&#32;up&#32;after&#32;an&#32;exception.&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;&#47;summary&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;remarks&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;Don&#39;t&#32;do&#32;anything&#32;that&#32;could&#32;throw&#32;in&#32;this&#32;method,&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;it&#32;will&#32;cause&#32;later&#32;recover&#32;operations&#32;to&#32;get&#32;skipped&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;and&#32;play&#32;real&#32;havok&#32;with&#32;the&#32;stack&#32;trace.&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#47;&#47;&#47;&#32;&#38;lt&#59;&#47;remarks&#38;gt&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;public&#32;void&#32;Recover&#40;&#41;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#123;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;TryExit&#40;&#41;&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#125;&#32;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;private&#32;void&#32;TryExit&#40;&#41;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#123;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;if&#32;&#40;hasMonitorEntered&#41;&#47;&#47;inside&#32;of&#32;synchronised&#32;section&#32;if&#32;true,&#32;therefore&#32;thread&#32;safe&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#123;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;hasMonitorEntered&#32;&#61;&#32;false&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;Monitor.Exit&#40;lockObj&#41;&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#125;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#125;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#125;&#32;&#32;Then&#32;you&#32;just&#32;have&#32;to&#32;create&#32;an&#32;exact&#32;replica&#32;of&#32;ContainerControlledLifetimeManager&#32;which&#32;inherits&#32;from&#32;the&#32;new&#32;SynchronizedLifetimeManager&#32;and&#32;still&#32;implements&#32;IDisposible.&#32;&#32;Finally,&#32;just&#32;call&#58;&#32;&#38;quot&#59;containerInstance.RegisterInstance&#38;lt&#59;T&#38;gt&#59;&#40;instance,&#32;new&#32;ContainerControlledLifetimeManager&#40;&#41;&#41;&#59;&#38;quot&#59;&#32;with&#32;the&#32;new&#32;ContainerControlledLifetimeManager.&#32;&#32;&#40;Note&#58;&#32;I&#32;have&#32;updated&#32;the&#32;above&#32;code&#32;in&#32;after&#32;ctavares&#39;&#32;comments&#32;below&#32;so&#32;that&#32;the&#32;hasMonitorEntered&#32;field&#32;is&#32;volatile&#32;&#91;http&#58;&#47;&#47;msdn.microsoft.com&#47;en-us&#47;library&#47;x13ttww7.aspx&#93;&#41;&#32;">
        Whilst using Unity I had the same issue of &quot;in debug mode, I'll get a SynchronizationLockException which is internally caught&quot; so I thought it might be useful to post a full solution that other people could use.<br>
<br>
&gt; You also assumed that if GetValue was called and value was null, that SetValue would necessarily be called.<br>
<br>
If SetValue is called without GetValue being called then a subtly different but simpler solution would be to set a boolean variable after entering the monitor so that upon exiting this value can be checked before exiting:<br>
<br>
public abstract class SynchronizedLifetimeManager : LifetimeManager, IRequiresRecovery<br>
&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private object lockObj = new object();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private <strong>volatile</strong> bool hasMonitorEntered;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// Retrieve a value from the backing store associated with this Lifetime policy.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;returns&gt;the object desired, or null if no such object is currently stored.&lt;/returns&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;remarks&gt;Calls to this method acquire a lock which is released only if a non-null value<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// has been set for the lifetime manager.&lt;/remarks&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public override object GetValue()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Monitor.Enter(lockObj);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>hasMonitorEntered = true;//inside of synchronised section</strong><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object result = SynchronizedGetValue();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (result != null)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Monitor.Exit(lockObj);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return result;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// Performs the actual retrieval of a value from the backing store associated
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// with this Lifetime policy.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;returns&gt;the object desired, or null if no such object is currently stored.&lt;/returns&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;remarks&gt;This method is invoked by &lt;see cref=&quot;SynchronizedLifetimeManager.GetValue&quot;/&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// after it has acquired its lock.&lt;/remarks&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected abstract object SynchronizedGetValue();<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// Stores the given value into backing store for retrieval later.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;param name=&quot;newValue&quot;&gt;The object being stored.&lt;/param&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;remarks&gt;Setting a value will attempt to release the lock acquired by
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;see cref=&quot;SynchronizedLifetimeManager.GetValue&quot;/&gt;.&lt;/remarks&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public override void SetValue(object newValue)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SynchronizedSetValue(newValue);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TryExit();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// Performs the actual storage of the given value into backing store for retrieval later.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;param name=&quot;newValue&quot;&gt;The object being stored.&lt;/param&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;remarks&gt;This method is invoked by &lt;see cref=&quot;SynchronizedLifetimeManager.SetValue&quot;/&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// before releasing its lock.&lt;/remarks&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected abstract void SynchronizedSetValue(object newValue);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// Remove the given object from backing store.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public override void RemoveValue()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// A method that does whatever is needed to clean up<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// as part of cleaning up after an exception.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;remarks&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// Don't do anything that could throw in this method,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// it will cause later recover operations to get skipped<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// and play real havok with the stack trace.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/remarks&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void Recover()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TryExit();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void TryExit()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>if (hasMonitorEntered)//inside of synchronised section if true, therefore thread safe</strong><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong> hasMonitorEntered = false;</strong><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Monitor.Exit(lockObj);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
&nbsp;&nbsp;&nbsp; }<br>
<br>
Then you just have to create an exact replica of ContainerControlledLifetimeManager which inherits from the new SynchronizedLifetimeManager and still implements IDisposible.<br>
<br>
Finally, just call: &quot;containerInstance.RegisterInstance&lt;T&gt;(instance, new ContainerControlledLifetimeManager());&quot; with the new ContainerControlledLifetimeManager.<br>
<br>
(Note: I have updated the above code in after ctavares' comments below so that the hasMonitorEntered field is volatile [http://msdn.microsoft.com/en-us/library/x13ttww7.aspx])<br>

        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_143167" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="143170">
    <td id="PostDetailsCell_143170" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post143170"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/ctavares">ctavares</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="12/28/2008 6:34:01 AM" LocalTimeTicks="1230474841">Dec 28, 2008 at 6:34 AM</span></div>
            
        </div>
    </td>
    <td id="PostContent_143170" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post " 
        data-markdown="That&#39;s&#32;an&#32;interesting&#32;approach.&#32;You&#39;d&#32;probably&#32;need&#32;to&#32;mark&#32;the&#32;bool&#32;as&#32;volatile&#32;to&#32;get&#32;it&#32;to&#32;work&#32;correctly&#32;100&#37;&#32;of&#32;the&#32;time.&#32;&#32;Although,&#32;if&#32;the&#32;goal&#32;is&#32;just&#32;to&#32;avoid&#32;the&#32;break&#32;in&#32;the&#32;debugger,&#32;the&#32;easiest&#32;thing&#32;to&#32;do&#32;is&#32;turn&#32;off&#32;the&#32;&#38;quot&#59;Just&#32;My&#32;Code&#38;quot&#59;&#32;checkbox&#32;in&#32;the&#32;debugger&#32;options.&#32;Then&#32;it&#32;won&#39;t&#32;break&#32;on&#32;exceptions&#32;that&#32;are&#32;thrown&#32;through&#32;user&#32;code,&#32;only&#32;on&#32;genuinely&#32;unhandled&#32;exceptions.&#32;">
        That's an interesting approach. You'd probably need to mark the bool as volatile to get it to work correctly 100% of the time.<br>
<br>
Although, if the goal is just to avoid the break in the debugger, the easiest thing to do is turn off the &quot;Just My Code&quot; checkbox in the debugger options. Then it won't break on exceptions that are thrown through user code, only on genuinely unhandled
 exceptions.<br>

        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_143170" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="170787">
    <td id="PostDetailsCell_170787" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post170787"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/tschaena">tschaena</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="3/23/2009 10:45:00 AM" LocalTimeTicks="1237830300">Mar 23, 2009 at 10:45 AM</span></div>
            
        </div>
    </td>
    <td id="PostContent_170787" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post " 
        data-markdown="Hi&#32;Richard,&#32;&#32;Thanks&#32;for&#32;your&#32;solution.&#32;I&#32;think&#32;it&#32;is&#32;never&#32;a&#32;good&#32;idea&#32;to&#32;&#40;almost&#41;&#32;force&#32;a&#32;throw&#32;of&#32;an&#32;exception.&#32;Using&#32;a&#32;flag&#32;is&#32;much&#32;nicer&#32;and&#32;more&#32;performant&#32;&#40;exceptions&#32;are&#32;a&#32;performance&#32;killer&#41;.&#32;">
        Hi Richard,<br>
<br>
Thanks for your solution. I think it is never a good idea to (almost) force a throw of an exception. Using a flag is much nicer and more performant (exceptions are a performance killer).<br>

        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_170787" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="178495">
    <td id="PostDetailsCell_178495" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post178495"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/Tcogel">Tcogel</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="4/13/2009 8:37:55 AM" LocalTimeTicks="1239637075">Apr 13, 2009 at 8:37 AM</span></div>
            
        </div>
    </td>
    <td id="PostContent_178495" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post " 
        data-markdown="that&#32;SynchronizationLockException&#32;won&#39;t&#32;occur&#32;when&#32;Microsoft.Practices.Unity.dll&#32;from&#32;Microsoft&#32;Enterprise&#32;Library&#32;4.1&#32;-&#32;October&#32;2008&#92;Bin&#32;is&#32;used.&#32;">
        that&nbsp;SynchronizationLockException won't occur&nbsp;when Microsoft.Practices.Unity.dll from<br>
Microsoft Enterprise Library 4.1 - October 2008\Bin is&nbsp;used.<br>

        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_178495" class="Options" >
            
        </div>
        
    </td>
</tr>

</table>
    </div>

    
        <div class="StandardMarginTop">
            <a id="SignInToAddCommentLink" href="https://www.codeplex.com/site/login?RedirectUrl=http%3a%2f%2funity.codeplex.com%2fdiscussions%2f24710">
                Sign in to post message or set email notifications
            </a>
        </div>
    


    <div id="PostEditorContainer">
        <a name="editor"></a>
        <div id="Editor" style="display: none;">
            

<div class="MarkdownEditor" data-options-id="19d24dd8-01b7-45c7-98bf-7e0454edc2b9">
    <script class="options" defer="defer" id="19d24dd8-01b7-45c7-98bf-7e0454edc2b9" type="application/json">{"maxLength":10000,"styleSheetLocation":""}</script>

    <div class="MarkdownEditorControls">
        <a href="#" tabindex="-1" class="control md_help" title="Markdown Syntax Guide"></a>
        <div class="control md_divider"></div>
        <a href="#" tabindex="-1" class="control md_header" title="Insert Header (CTRL + H)"></a>
        <a href="#" tabindex="-1" class="control md_code" title="Insert Code (CTRL + K)"></a>
        <a href="#" tabindex="-1" class="control md_quote" title="Insert Quote (CTRL + Q)"></a>
        <a href="#" tabindex="-1" class="control md_img" title="Insert Img (CTRL + G)"></a>
        <a href="#" tabindex="-1" class="control md_link" title="Insert Link (CTRL + L)"></a>
        <a href="#" tabindex="-1" class="control md_ulist" title="Unordered List (CTRL + U)"></a>
        <a href="#" tabindex="-1" class="control md_olist" title="Ordered List (CTRL + O)"></a>
        <a href="#" tabindex="-1" class="control md_italics" title="Italic Text (CTRL + I)"></a>
        <a href="#" tabindex="-1" class="control md_bold" title="Bold Text (CTRL + B)"></a>
    </div>

    

<div class="tab_control">
    <!-- Generate the basic HTML for the tabs. -->
    
        <div id="Compose"
              class="tab selected"
              data-custom-header-id=""
              data-tab-contents-id="compose_contents_605a3ff3-f831-4aa6-8496-13f9037dc72f">
            Compose
        </div>
    
        <div id="Preview"
              class="tab "
              data-custom-header-id=""
              data-tab-contents-id="preview_contents_7bfc5b24-a9ea-44d5-a50d-05fb1a41090a">
            Preview
        </div>
    
    <div class="clear"></div>
</div>


    <div id="compose_contents_605a3ff3-f831-4aa6-8496-13f9037dc72f" class="compose_tab_content">
        <textarea class=" MarkdownEditorDimensions" cols="20" id="MarkdownEditor" name="content" rows="2">
</textarea>
        <div class="ClearBoth"></div>

        <div class="markdownGuide" style="display: none">
            <table>
                <tr>
                    <td class="markdownGuideColumn">
                        <h1>Text Formatting</h1>
                        <div># Header 1</div>
                        <div>## Header 2</div>
                        <br />
                        <div>*italics* (or _italics_)</div>
                        <div>**bold** (or __bold__)</div>
                    </td>
                    <td class="markdownGuideColumn">
                        <h1>Lists</h1>
                        <div>* Unordered List</div>
                        <div>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp * SubItem</div>
                        <br />
                        <div>1. Ordered List</div>
                        <div>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp 1. SubItem</div>
                    </td>
                    <td class="markdownGuideColumn">
                        <h1>Quotes</h1>
                        <div>> Lorem ipsum</div>
                        <div>dolor sitamet </div>
                        <div>non. Lectus at</div>
                        <div>nam nunc...</div>
                    </td>
                    <td class="markdownGuideColumn">
                        <h1>Code</h1>
                        <div>`Inline Code`</div>
                        <br />
                        <div>``` C#</div>
                        <div>if (foo==bar)</div>
                        <div>&nbsp&nbsp&nbsp&nbsp&nbsp&nbspbar++</div>
                        <div>```</div>
                    </td>
                    <td class="markdownGuideColumn">
                        <h1>References</h1>
                        <div>[Link Text](URL)</div>
                        <br />
                        <div>![Image](URL)</div>
                        <br />
                        <a class="Reference" target="_blank" href="http://codeplex.codeplex.com/wikipage?title=Markdown&referringTitle=Documentation">Markdown Reference</a>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div id="preview_contents_7bfc5b24-a9ea-44d5-a50d-05fb1a41090a" class="preview_tab_content markDownOutput">
        
            <div></div>
        
    </div>
    <div class="clear"></div>
</div>

            
            <div class="row" id="recaptcha_row">
                
<script type="text/javascript">
    $(document).ready(function () {
        $('#recaptcha_reload').attr('src', '../assets/recaptcha_refresh.png');
        $('#recaptcha_switch_audio').attr('src', '../assets/recaptcha_audio.png');
        $('#recaptcha_switch_img').attr('src', '../assets/recaptcha_text.png');
        $('#recaptcha_whatsthis').attr('src', '../assets/recaptcha_help.png');
        $('#recaptcha_area tr:first').attr('height', '35');
    });
</script>

                <div class="clear"></div>
                <span id="ReCaptchaError"></span>
            </div>
            <div style="padding-top: 6px;">
                <input type="button" id="SaveButton" value="Save" class="ok" />
                <input type="button" id="CancelButton" value="Cancel" class="cancel" />
                <div class="clear"></div>
            </div>
        </div>
    </div>
</div>

<div id="DeletePostPanel" class="modal" style="display:none">
    <div class="row">
        <h2>Delete Post <a href="javascript:return false;" class="close">X</a></h2>
    </div>
    <div class="modal_info">
        <p>Are you sure you want to delete this post? You will not be able to recover it later.</p>
        <p class="modal_buttons">
            <input type="button" id="ClosePostCancel" value="Cancel" class="cancel" />
            <input type="button" id="ClosePostOk" value="Delete" class="ok" />
        </p>
        <div class="ClearBoth"></div>
    </div>
</div>
        
            <!-- Email notification / Subscription details -->
            
    </div>
</div>
    
<div id="DeleteThreadPanel" class="modal" style="display:none">
    <div class="row">
        <h2>Delete Thread <a href="javascript:return false;" class="close">X</a></h2>
    </div>
    <div class="modal_info">
        <p>Are you sure you want to delete this thread? You will not be able to recover it later.</p>
        <p class="modal_buttons">
            <input type="button" id="CloseThreadCancel" value="Cancel" class="cancel" />
            <input type="button" id="CloseThreadOk" value="Delete" class="ok" />
        </p>
        <div class="ClearBoth"></div>
    </div>
</div>

<script type="text/javascript" language="javascript">
    $(function () {

        $('#recaptcha_response_field')
            .bind('keypress', function (event) { return $submitKeyPressElement(this, event); });


        if ($('#DeleteThreadLink')) {
            $('#DeleteThreadLink').click(function () {
                OpenDialog('#DeleteThreadPanel', true, '41em');
            });
        }
        
        $('#DeleteThreadPanel #CloseThreadOk').click(function () {
            var url = 'http://unity.codeplex.com/discussions/24710';
            $.ajax({
                url: url,
                type: 'DELETE',
                success: function (x) {
                    location.href = x.RedirectUrl;
                }
            });
        });
    });

    workItemMention = new codeplex.ui.WorkItemMention();
    workItemMention.addLinks(".discussionPost");
</script>


        
        
                
                <div class="clear"></div>
                
                <div id="footer">
                    <div class="row">
                        <hr />
                        <ul>
                            <li>Â© 2006-2017 Microsoft</li>
                            <li><a href="http://www.codeplex.com/site/help">Get Help</a></li>
                            <li><a href="/site/legal/privacy">Privacy Statement</a></li>
                            <li><a href="http://www.codeplex.com/site/legal/terms">Terms of Use</a></li>
                            <li><a href="http://www.codeplex.com/site/legal/conduct">Code of Conduct</a></li>
                            <li><a href="http://developermedia.com/" target="_blank">Advertise With Us</a></li>
                            <li>Version 2017.10.3.21062</li>
                        </ul>
                    </div>
                </div>
            </div>
        </form>
    </body>

</html>