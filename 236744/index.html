

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" class="" prefix="og: http://ogp.me/ns# profile: http://ogp.me/ns/profile#">
    
    
    
    

    
    <head>
        <meta id="CompatabilityMode" http-equiv="X-UA-Compatible" content="IE=edge" />
	    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link href="../assets/StyleSheet.css" id="MasterCss" rel="stylesheet" type="text/css" />
        <link rel="SHORTCUT ICON" href="../assets/favicon.ico" />
        <title>patterns &#38; practices - Unity - Upgrading a Unity 1.2 custom build strategy to 2.0</title>
        
       
                    <script src="../assets/mscc-0.3.6.min.js"></script>
        
                    <link rel="stylesheet" type="text/css" href="../assets/mscc-0.3.6.min.css" />
        
            <script type="text/javascript">
                var msccHadCookieBannerAtPageStart = true;
            </script>
        

        <!--
        Third party scripts and code linked to or referenced from this website are licensed to you by the parties that own such code,
        not by Microsoft.  See ASP.NET Ajax CDN Terms of Use â€“ http://www.asp.net/ajaxlibrary/CDN.ashx.
        -->
        <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-1.4.4.min.js" type="text/javascript"></script>
        
        <script type="text/javascript">
            if (typeof jQuery === 'undefined') {
                document.write(unescape("%3Cscript src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js' type='text/javascript'%3E%3C/script%3E"));
            }
        </script>

        <script src="https://ajax.aspnetcdn.com/ajax/jquery.ui/1.8.6/jquery-ui.min.js" type="text/javascript"></script>
        
        <script type="text/javascript">
            if (typeof jQuery.ui === 'undefined') {
                document.write(unescape("%3Cscript src='https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.6/jquery-ui.min.js' type='text/javascript'%3E%3C/script%3E"));
            }
        </script>

        
    <style type="text/css">.SideBar, .SideBarPadding{display:none;}.MainContent{width:auto;}.SiteContentTable{width:100%;}</style>
    <style id="ProjectStyles" type="text/css">
        .SiteHeader, .SiteHeaderLeft {
            height:45px !important;
            overflow:hidden;
        }
        .SiteContent 
        {
            padding: 0 0 1em 0;
            margin-top:0;
            min-height:225px;
            border-right: 1px solid lightgrey;
            border-left: 1px solid lightgrey;
            border-bottom: 1px solid lightgrey;
        }
        .IE table.MinWidthContent
        {
	        table-layout: auto !important;	
        }
    </style>
    
    
    <meta name="ROBOTS" content="NOINDEX, NOFOLLOW">

    
    
    <meta id="WTProjectName" name="WT.pi" content="unity"/>
    

    <link rel="EditURI" type="application/rsd+xml" title="RSD" href='http://unity.codeplex.com/rsd' />
    <link rel="wlwmanifest" type="application/wlwmanifest+xml" title="WLWManifest" href='/wlwmanifest.xml' />
    
    
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity" url="http://unity.codeplex.com/project/feeds/rss"/>
    
        
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Discussions" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fforum%2funity"/>
        
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Issues" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fworkitem%2funity"/>
        
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Downloads" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2frelease%2funity"/>
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Reviews" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2freview%2funity"/>
        
    
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Source&#32;code" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fsourcecontrol%2funity"/>
        <link rel="alternate" type="application/rss+xml" title="patterns&#32;&#38;&#32;practices&#32;-&#32;Unity&#32;-&#32;Wiki" url="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fwiki%2funity"/>
    
        
    
        <meta content="summary" name="twitter:card" /><meta content="@CodePlex" name="twitter:site" /><meta content="http://unity.codeplex.com/discussions/236744?ProjectName=unity" name="twitter:url" /><meta content="patterns &amp;#38; practices - Unity" name="twitter:title" /><meta content="The Unity Application Block &amp;#40;Unity&amp;#41; is officially under new ownership.&amp;#13;&amp;#10;https&amp;#58;&amp;#47;&amp;#47;github.com&amp;#47;unitycontainer&amp;#47;unity" name="twitter:description" /><meta content="http://www.codeplex.com/Images/codeplex.png" name="twitter:image" /><meta content="CodePlex" property="og:site_name" /><meta content="http://unity.codeplex.com/discussions/236744?ProjectName=unity" property="og:url" /><meta content="object" property="og:type" /><meta content="patterns &amp;#38; practices - Unity" property="og:title" /><meta content="The Unity Application Block &amp;#40;Unity&amp;#41; is officially under new ownership.&amp;#13;&amp;#10;https&amp;#58;&amp;#47;&amp;#47;github.com&amp;#47;unitycontainer&amp;#47;unity" property="og:description" /><meta content="http://www.codeplex.com/Images/codeplex.png" property="og:image" />
        

    </head>
    
    <body>
         
            
        <script src="../assets/ScriptLoader.js" type="text/javascript"></script>
        <form id="aspnetForm" autocomplete="off" method="POST" enctype="multipart/form-data">
            <input name="__RequestVerificationToken" type="hidden" value="BWXAEut_NrOUnzyD3ZZ-Xbhll80pfFqI4q4rn8Wmfw9__1XnhOfILhu-CCtq7cNOnPBbTZSBgW35ML297HoFRpS1w3N1FeKtLraRcUgvsb0pZavcl_gzkVMq_LUkzjMgWslagA2" /><input name="__RequestVerificationToken2" type="hidden" value="__RequestVerificationToken225ca688e-bda3-45f8-a170-2c815d2a24da" />
            
            <div id="UpdateProgressPanel" class="loading_animation" style="display:none;">
                <div class="row">
                    <h2 class="anim_h2">
                        <span id="UpdateProgressText">Updating...</span>
                        <span id="animatedLoadingIconContainer">
                            <img id="animatedLoadingIcon" src="../assets/loading_animation.gif" class="anim_img"/>
                        </span>
                    </h2>
                </div>
            </div>
            
            <div style="display:none;">
                
                <img id="BlankImage" style="width:0;height:0;" src="../assets/blank.png" onload="self.logoImageLoaded=true;"/>

                <script language="javascript" type="text/javascript">
                    var date = new Date();
                    var timezoneOffset = date.getTimezoneOffset() / 60 * -1;
                    var timezoneOffsetCookie = getCookie("TimezoneOffset");
                    var firstTimeSetTimezoneCookie = false;

                    if (timezoneOffsetCookie == null || timezoneOffsetCookie != timezoneOffset) {
                        firstTimeSetTimezoneCookie = true;
                        document.cookie = "TimezoneOffset=" + timezoneOffset + '; domain=.codeplex.com;expires=Wed, 10 Oct 2018 05:27:02 UTC';
                    }
                </script>
            </div>
            
            
            <div id="banner">
                <div id="message"><strong>This is an archived copy of the original CodePlex Unity Discussion Forum</strong><br />Unity is now on <a href="https://github.com/unitycontainer/">GitHub</a>
                    
                </div>
            </div>
            

            <div id="header">
                <div id="header_wrap" class="row">
                    <p id="logo"><a href="http://www.codeplex.com">Code<span class="semi">Plex</span></a><span id="tagline">Project Hosting for Open Source Software</span></p>
                    

<ul id="nav">

    <li><a href="/site/register/new" id="registerLink" class="ZoomFix">Register</a></li>
    <li ><a class="SignInLink" href="https://www.codeplex.com/site/login?RedirectUrl=http%3a%2f%2funity.codeplex.com%2fdiscussions%2f236744" id="signInLink">Sign In</a></li>
  
    <li class="last"><a class="rss_site_icon" href="http://www.codeplex.com/site/feeds/rss" type="application/rss+xml" rel="Alternate" title="CodePlex Site Activity"></a></li>
</ul>
                    <input id="searchsite" name="searchsite" maxlength="500" type="text" value="" /><span id="search_mag"><a id="submitSearch" name="submitSearch" class="magnify" title="Search" href="#"></a></span>
                    <script>
	$(document).ready(function() {
    var searchButton = $('#submitSearch'),
        searchBar = $('#searchsite');

    // Register our own handler for the search event while we wait for the SearchBox script to load.
    searchButton.bind('click.backupSearchBox', doProjectSearch);
    searchBar.bind('keypress.backupSearchBox', function(e) { if ($keyCode(e) === 13) { doProjectSearch(); return false; } });

    function cleanupSearchEvents() {
        // If the SearchBox was loaded, unregister our handlers.
        if (epx_loaded) {
            searchButton.unbind('.backupSearchBox');
            searchBar.unbind('.backupSearchBox');
        }
    }

    $loadScript('https://i4.services.social.microsoft.com/search/Widgets/SearchBox.jss?appid=1000&scopeid=1&boxId=searchsite&btnId=submitSearch&watermark=Search%20all%20projects&overrideWatermark=true&searchLocation=%2fsite%2fsearch&allowEmptySearch=true&focusOnInit=False&minimumTermLength=3', cleanupSearchEvents);
})
function doProjectSearch() {
    
    var url = '/site/search';

    //If search term is not same as watermark
    if($('#searchsite').val() != 'Search all projects')    
    {        
        url = url + '?query=' + encodeURIComponent($('#searchsite').val());
    }

    
    var callback = '';
    if (callback.length > 0 && eval('typeof ' + callback) != 'undefined')
        url += eval(callback + '()');

    window.location.href = url;
    return false;
}
</script>
                </div>
            </div>
            
            <div id="wrap">
                
    <div id="sub_heading" class="row">
        
        <div id="ProjectHeader">
            <div id="project_title_row" class="row">
                <div id="project_logo">
                    
<a id="AffiliateLink" href="http://msdn.microsoft.com/practices">
    <img id="AffiliateImage" src="../assets/pnp_logo.png" title="patterns&#32;&#38;&#32;practices" />
</a>

    
    <h1 class="text_only"><a href="http://unity.codeplex.com/" id="ProjectTitle1"><div>patterns &#38; practices - Unity</div></a></h1>

                </div>
            </div>
        </div>
        
        <div id="ProjectDetailsDiv">
            
        </div>
		<div class="clear"></div>
        

<ul id="page_box_links">
	<li id="homeTabCell" style="width: 63px;"><a id="homeTab" href="http://unity.codeplex.com/" class="box_home">home</a><div></div></li>
    
	<li id="sourceTabCell" style="width:113px;"><a id="sourceTab" href="http://unity.codeplex.com/SourceControl/latest" class="box_source">source code</a><div></div></li>
    
	<li id="releasesTabCell" style="width:105px;"><a id="releasesTab" href="http://unity.codeplex.com/releases" class="box_downloads">downloads</a><div></div></li>
    
    <li id="documentationTabCell" style="width:143px;"><a id="documentationTab" href="http://unity.codeplex.com/documentation" class="box_documentation">documentation</a><div></div></li>
    
	<li id="discussionTabCell" style="width:112px;"><a id="discussionTab" href="../index.html" class="discussions_active">discussions</a><div></div></li>
    
	<li id="workItemsTabCell" style="width:70px;"><a id="workItemsTab" href="http://unity.codeplex.com/workitem/list/basic" class="box_issue">issues</a><div></div></li>
    
	<li id="peopleTabCell" style="width:70px;"><a id="peopleTab" href="http://unity.codeplex.com/team/view" class="box_people">people</a><div></div></li>
	<li id="licenseTabCell" style="width:70px;"><a id="licenseTab" href="http://unity.codeplex.com/license" class="box_license">license</a><div></div></li>
    
    <span class="stretch"></span>
</ul>

<script type="text/javascript">
    $(document).ready(function () {
        $('#page_box_links').applyLastClassToList();
    });
</script>
		    <div class="clear"></div>
            
     <td>
       

<div>
    
    <div id="actionBar" class="action_bar">
        <ul id="actionBar_ul" class="actionBar_sublinks subtab_right" style="vertical-align: middle;">

            

                <li id="li_actionbar_creatediscussion" data-action-id="actionbar_creatediscussion" data-action-type="Navigate" class="actionBar_sublinks" data-options-id="7cb989aa-1991-49b9-bcd6-663c7c869422">
                
                    <script class="options" defer="defer" id="7cb989aa-1991-49b9-bcd6-663c7c869422" type="application/json">{"navigate-url":"http://unity.codeplex.com/discussions/create"}</script> 
                    
                    <div class="actionBar_custom_content"></div>

                    <a href="#" id="actionbar_creatediscussion" title="Start a New Thread" class="action_bar_item_link">
                        <img id="img_actionbar_creatediscussion" class="action_bar_item_image" src="../assets/actionbar_newitem.png" style="vertical-align: middle" />
                        New Thread
                    </a>

                </li>

            

                <li id="li_actionbar_subscribe" data-action-id="actionbar_subscribe" data-action-type="PopUp" class="actionBar_sublinks" data-options-id="d1330d58-b0fe-4df1-8e0b-263ed150e919">
                
                    <script class="options" defer="defer" id="d1330d58-b0fe-4df1-8e0b-263ed150e919" type="application/json">{}</script> 
                    
                    <div class="actionBar_custom_content">

<div id="rssHoverDiv" class="HoverPanel LeftHoverWidth" style="display: none">
        <ul id="3_FeedsPanel" class="RssFeedsPanel">
            <li>
                <a id="ProjectRssLink" href="http://unity.codeplex.com/project/feeds/rss" class="ArrowSmall NoUnderline">All Project Updates</a>
            </li>
            
            <li>
                <a id="DiscussionRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fforum%2funity" class="ArrowSmall NoUnderline">Discussions</a>
            </li>
            
            <li>
                <a id="IssueTrackerRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fworkitem%2funity" class="ArrowSmall NoUnderline">Issue Tracker</a>
            </li>
            
            <li>
                <a id="ReleasesRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2frelease%2funity" class="ArrowSmall NoUnderline">Downloads</a>
            </li>
            <li>
                <a id="ReviewsRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2freview%2funity" class="ArrowSmall NoUnderline">Reviews</a>
            </li>
            
            <li>
                <a id="SourceControlRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fsourcecontrol%2funity" class="ArrowSmall NoUnderline">Source Code</a>
            </li>
            <li>
                <a id="WikiRssLink" href="http://unity.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fwiki%2funity" class="ArrowSmall NoUnderline">Wiki &amp; Documentation</a>
            </li>
        </ul>
</div></div>

                    <a href="#" id="actionbar_subscribe" title="Subscribe to project updates in RSS feeds." class="action_bar_item_link">
                        <img id="img_actionbar_subscribe" class="action_bar_item_image" src="../assets/actionbar_subscribe.png" style="vertical-align: middle" />
                        Subscribe
                    </a>

                </li>

            
        </ul>
    </div>
</div>
     </td>

        

    </div>
    
    
<div class="Threads">
    <div class="ViewThread">
        
        
        
            <h1 class="page_title WordWrapBreakWord">
                Upgrading a Unity 1.2 custom build strategy to 2.0
            </h1>

            <!-- Private Discussion header -->
            

            <!-- Posts List Header: Topics and Wiki Link -->
            <table class="PostsListHeader">
                <tr>
                    <td>
                     
                    </td>
                    <td>
                        <div class="WikiLink">
                            <span title="Paste this into a wiki page to link to this discussion">
                                Wiki Link: [discussion:236744]
                            </span>
                        </div>
                    </td>
                </tr>
            </table>

            <!-- The list of posts -->
            

<div id="discussionsPostList" data-options-id="f05c4e54-5615-4c36-9f3b-0ff185c11b1b">
    <script class="options" defer="defer" id="f05c4e54-5615-4c36-9f3b-0ff185c11b1b" type="application/json">{"threadUrl":"http://unity.codeplex.com/discussions/236744","showEditor":false,"checkImageUrl":"../assets/check_answer.png"}</script>

    <div class="Posts" style="margin-top: 10px;">
    

<table cellpadding="0" cellspacing="0" style="width: 100%; margin-bottom: 0px; table-layout:fixed">
    

<tr id="PostPanel" class="Post" d:forid="529580">
    <td id="PostDetailsCell_529580" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post529580"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/markheath">markheath</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="12/1/2010 5:36:18 PM" LocalTimeTicks="1291253778">Dec 1, 2010 at 5:36 PM</span></div>
            
        </div>
    </td>
    <td id="PostContent_529580" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post " 
        data-markdown="&#32;I&#32;have&#32;a&#32;custom&#32;extension&#32;I&#32;created&#32;for&#32;Unity&#32;1.2.&#32;Basically&#32;what&#32;I&#32;am&#32;trying&#32;to&#32;achieve&#32;is&#32;for&#32;every&#32;call&#32;to&#32;Resolve&#32;for&#32;an&#32;interface&#32;inheiting&#32;from&#32;a&#32;certain&#32;base&#32;interface,&#32;I&#32;want&#32;to&#32;create&#32;the&#32;object&#32;with&#32;my&#32;own&#32;factory.&#32;I&#32;want&#32;that&#32;object&#32;then&#32;to&#32;be&#32;cached&#32;in&#32;the&#32;container&#32;with&#32;a&#32;container&#32;controlled&#32;lifetime&#32;manager.&#32;Here&#39;s&#32;the&#32;code&#32;I&#32;was&#32;using&#32;in&#32;Unity&#32;1.2&#32;&#32;public&#32;class&#32;FactoryMethodUnityExtension&#38;lt&#59;T&#38;gt&#59;&#32;&#58;&#32;UnityContainerExtension&#32;&#123;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;private&#32;Func&#38;lt&#59;Type,T&#38;gt&#59;&#32;factory&#59;&#32;&#38;nbsp&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;public&#32;FactoryMethodUnityExtension&#40;Func&#38;lt&#59;Type,T&#38;gt&#59;&#32;factory&#41;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;this.factory&#32;&#61;&#32;factory&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#32;&#38;nbsp&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;protected&#32;override&#32;void&#32;Initialize&#40;&#41;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;var&#32;strategy&#32;&#61;&#32;new&#32;CustomFactoryBuildStrategy&#38;lt&#59;T&#38;gt&#59;&#40;factory,&#32;Context&#41;&#59;&#32;&#38;nbsp&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;Context.Strategies.Add&#40;strategy,&#32;UnityBuildStage.PreCreation&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#32;&#125;&#32;&#38;nbsp&#59;&#32;public&#32;class&#32;CustomFactoryBuildStrategy&#38;lt&#59;T&#38;gt&#59;&#32;&#58;&#32;BuilderStrategy&#32;&#123;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;private&#32;Func&#38;lt&#59;Type,T&#38;gt&#59;&#32;factory&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;private&#32;ExtensionContext&#32;baseContext&#59;&#32;&#38;nbsp&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;public&#32;CustomFactoryBuildStrategy&#40;Func&#38;lt&#59;Type,T&#38;gt&#59;&#32;factory,&#32;ExtensionContext&#32;baseContext&#41;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;this.factory&#32;&#61;&#32;factory&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;this.baseContext&#32;&#61;&#32;baseContext&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#32;&#38;nbsp&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;public&#32;override&#32;void&#32;PreBuildUp&#40;IBuilderContext&#32;context&#41;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;var&#32;key&#32;&#61;&#32;&#40;NamedTypeBuildKey&#41;context.OriginalBuildKey&#59;&#32;&#38;nbsp&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;if&#32;&#40;key.Type.IsInterface&#32;&#38;amp&#59;&#38;amp&#59;&#32;typeof&#40;T&#41;.IsAssignableFrom&#40;key.Type&#41;&#41;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;object&#32;existing&#32;&#61;&#32;baseContext.Locator.Get&#40;key.Type&#41;&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;if&#32;&#40;existing&#32;&#61;&#61;&#32;null&#41;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#47;&#47;&#32;create&#32;it&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;context.Existing&#32;&#61;&#32;factory&#40;key.Type&#41;&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#47;&#47;&#32;cache&#32;it&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;baseContext.Locator.Add&#40;key.Type,&#32;context.Existing&#41;&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;else&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;context.Existing&#32;&#61;&#32;existing&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#32;&#125;&#32;&#32;However,&#32;in&#32;unity&#32;2.0&#32;this&#32;won&#39;t&#32;compile&#32;since&#32;the&#32;ExtensionContext&#32;no&#32;longer&#32;has&#32;a&#32;Locator.&#32;I&#32;can&#39;t&#32;use&#32;the&#32;container&#32;directly&#32;instead&#32;or&#32;I&#32;get&#32;a&#32;stack&#32;overflow&#32;exception.&#32;&#32;How&#32;do&#32;I&#32;work&#32;round&#32;this&#32;for&#32;unity&#32;2.0,&#32;or&#32;is&#32;there&#32;an&#32;easier&#32;way&#63;&#32;&#32;&#40;if&#32;you&#32;are&#32;wondering&#32;why&#32;I&#32;need&#32;to&#32;do&#32;this,&#32;it&#32;is&#32;because&#32;our&#32;application&#32;has&#32;around&#32;50&#32;interfaces&#32;that&#32;all&#32;need&#32;to&#32;be&#32;created&#32;using&#32;.NET&#32;remoting.&#32;they&#32;all&#32;inherit&#32;from&#32;the&#32;same&#32;base&#32;interface,&#32;so&#32;I&#32;want&#32;to&#32;set&#32;the&#32;container&#32;up&#32;to&#32;work&#32;for&#32;them&#32;all&#32;without&#32;explicitly&#32;registering&#32;a&#32;factory&#32;method&#32;for&#32;each&#32;and&#32;every&#32;one&#41;.&#32;&#32;thanks&#32;Mark&#32;&#32;">
        
<p>I have a custom extension I created for Unity 1.2. Basically what I am trying to achieve is for every call to Resolve for an interface inheiting from a certain base interface, I want to create the object with my own factory. I want that object then to be
 cached in the container with a container controlled lifetime manager. Here's the code I was using in Unity 1.2</p>
<div>
<div><code>public</code> <code>class</code> <code>FactoryMethodUnityExtension&lt;T&gt; : UnityContainerExtension</code></div>
<div><code>{</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>Func&lt;Type,T&gt; factory;</code></div>
<div>&nbsp;</div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>FactoryMethodUnityExtension(Func&lt;Type,T&gt; factory)</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>this</code><code>.factory = factory;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div>&nbsp;</div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>protected</code> <code>override</code>
<code>void</code> <code>Initialize()</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var strategy =
</code><code>new</code> <code>CustomFactoryBuildStrategy&lt;T&gt;(factory, Context);</code></div>
<div>&nbsp;</div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Context.Strategies.Add(strategy, UnityBuildStage.PreCreation);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div><code>}</code></div>
<div>&nbsp;</div>
<div><code>public</code> <code>class</code> <code>CustomFactoryBuildStrategy&lt;T&gt; : BuilderStrategy</code></div>
<div><code>{</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>Func&lt;Type,T&gt; factory;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>private</code> <code>ExtensionContext baseContext;</code></div>
<div>&nbsp;</div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>CustomFactoryBuildStrategy(Func&lt;Type,T&gt; factory, ExtensionContext baseContext)</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>this</code><code>.factory = factory;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>this</code><code>.baseContext = baseContext;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div>&nbsp;</div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code> <code>override</code>
<code>void</code> <code>PreBuildUp(IBuilderContext context)</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>var key = (NamedTypeBuildKey)context.OriginalBuildKey;</code></div>
<div>&nbsp;</div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code>
<code>(key.Type.IsInterface &amp;&amp; </code><code>typeof</code><code>(T).IsAssignableFrom(key.Type))</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>object</code>
<code>existing = baseContext.Locator.Get(key.Type);</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code>
<code>(existing == </code><code>null</code><code>)</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>// create it</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>context.Existing = factory(key.Type);</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>// cache it</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>baseContext.Locator.Add(key.Type, context.Existing);</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>else</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>context.Existing = existing;</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></div>
<div><code>}</code></div>
<div></div>
<div>However, in unity 2.0 this won't compile since the ExtensionContext no longer has a Locator. I can't use the container directly instead or I get a stack overflow exception.</div>
<div></div>
<div>How do I work round this for unity 2.0, or is there an easier way?</div>
<div></div>
<div>(if you are wondering why I need to do this, it is because our application has around 50 interfaces that all need to be created using .NET remoting. they all inherit from the same base interface, so I want to set the container up to work for them all without
 explicitly registering a factory method for each and every one).</div>
<div></div>
<div>thanks</div>
<div>Mark</div>
</div>

        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_529580" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="529835">
    <td id="PostDetailsCell_529835" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post529835"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/ctavares">ctavares</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="12/2/2010 4:05:16 AM" LocalTimeTicks="1291291516">Dec 2, 2010 at 4:05 AM</span></div>
            
            <div style="white-space: normal" class="SubText" id="UpdatedDiv">Edited <span class="smartDate" title="12/2/2010 4:06:28 AM" LocalTimeTicks="1291291588">Dec 2, 2010 at 4:06 AM</span></div>
            
        </div>
    </td>
    <td id="PostContent_529835" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post " 
        data-markdown="&#32;Instead&#32;of&#32;using&#32;the&#32;Locator,&#32;just&#32;create&#32;a&#32;policy&#32;to&#32;store&#32;the&#32;objects&#32;you&#39;ve&#32;cached,&#32;add&#32;the&#32;policy&#32;to&#32;the&#32;PersistentPolicies&#32;collection&#32;if&#32;it&#39;s&#32;not&#32;already&#32;there,&#32;and&#32;put&#32;the&#32;cached&#32;object&#32;in&#32;there.&#32;The&#32;primary&#32;reason&#32;the&#32;locator&#32;was&#32;removed&#32;was&#32;that&#32;it&#32;didn&#39;t&#32;actually&#32;add&#32;any&#32;capability,&#32;and&#32;it&#32;confused&#32;things&#32;about&#32;when&#32;to&#32;put&#32;stuff&#32;in&#32;a&#32;policy&#32;or&#32;in&#32;the&#32;locator.&#32;So&#32;I&#32;removed&#32;the&#32;confusion.&#32;Actually,&#32;the&#32;logic&#32;you&#39;re&#32;describing&#32;doesn&#39;t&#32;match&#32;the&#32;code&#32;you&#32;posted&#32;-&#32;adding&#32;it&#32;to&#32;the&#32;locator&#32;doesn&#39;t&#32;set&#32;a&#32;container&#32;controlled&#32;lifetime,&#32;instead&#32;it&#32;holds&#32;onto&#32;the&#32;object&#32;with&#32;a&#32;weak&#32;reference,&#32;and&#32;it&#32;won&#39;t&#32;get&#32;disposed&#32;when&#32;the&#32;container&#32;does.&#32;Again,&#32;for&#32;the&#32;lifetime,&#32;you&#32;create&#32;a&#32;ContainerControlledLifetimeManager&#32;&#40;which&#32;is&#32;a&#32;policy&#32;object&#41;,&#32;stick&#32;the&#32;object&#32;in&#32;it,&#32;and&#32;add&#32;it&#32;to&#32;the&#32;policy&#32;list.&#32;Actually,&#32;now&#32;that&#32;I&#32;think&#32;about&#32;it&#32;a&#32;little&#32;more,&#32;I&#32;suspect&#32;that&#32;the&#32;custom&#32;policy&#32;discussed&#32;isn&#39;t&#32;needed&#32;at&#32;all.&#32;You&#32;just&#32;set&#32;up&#32;the&#32;lifetime&#32;manager,&#32;then&#32;the&#32;second&#32;time&#32;through&#32;the&#32;lifetime&#32;manager&#32;will&#32;be&#32;populated&#32;and&#32;the&#32;object&#32;will&#32;be&#32;pulled&#32;from&#32;there,&#32;and&#32;the&#32;rest&#32;of&#32;the&#32;buildup&#32;chain&#32;doesn&#39;t&#32;even&#32;execute.&#32;&#38;nbsp&#59;&#32;&#38;nbsp&#59;&#32;&#38;nbsp&#59;&#32;">
        
<p>Instead of using the Locator, just create a policy to store the objects you've cached, add the policy to the PersistentPolicies collection if it's not already there, and put the cached object in there.</p>
<p>The primary reason the locator was removed was that it didn't actually add any capability, and it confused things about when to put stuff in a policy or in the locator. So I removed the confusion.</p>
<p>Actually, the logic you're describing doesn't match the code you posted - adding it to the locator doesn't set a container controlled lifetime, instead it holds onto the object with a weak reference, and it won't get disposed when the container does. Again,
 for the lifetime, you create a ContainerControlledLifetimeManager (which is a policy object), stick the object in it, and add it to the policy list.</p>
<p>Actually, now that I think about it a little more, I suspect that the custom policy discussed isn't needed at all. You just set up the lifetime manager, then the second time through the lifetime manager will be populated and the object will be pulled from
 there, and the rest of the buildup chain doesn't even execute.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_529835" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="529967">
    <td id="PostDetailsCell_529967" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post529967"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/markheath">markheath</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="12/2/2010 9:40:05 AM" LocalTimeTicks="1291311605">Dec 2, 2010 at 9:40 AM</span></div>
            
        </div>
    </td>
    <td id="PostContent_529967" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post " 
        data-markdown="&#32;thanks,&#32;although&#32;I&#39;m&#32;a&#32;little&#32;confused&#32;as&#32;to&#32;what&#32;exactly&#32;you&#32;are&#32;suggesting&#32;I&#32;do.&#32;I&#32;don&#39;t&#32;think&#32;I&#32;can&#32;create&#32;only&#32;a&#32;custom&#32;lifetime&#32;manager,&#32;since&#32;I&#32;need&#32;to&#32;itercept&#32;resolve&#32;for&#32;every&#32;interface&#32;that&#32;derives&#32;from&#32;a&#32;base&#32;type.&#32;The&#32;two&#32;things&#32;I&#32;can&#39;t&#32;do&#32;within&#32;my&#32;existing&#32;extension&#32;are&#32;1&#41;&#32;having&#32;created&#32;my&#32;object,&#32;store&#32;it&#32;in&#32;the&#32;container&#32;e.g.&#32;container.RegisterInstance&#40;derivedType,&#32;createdInstance&#41;&#32;2&#41;&#32;on&#32;the&#32;second&#32;request,&#32;retrieve&#32;it&#32;from&#32;the&#32;container&#32;container.Resolve&#40;derivedType&#41;&#32;Documentation&#32;on&#32;Unity&#32;2.0&#32;extensions&#32;seems&#32;to&#32;be&#32;&#32;thin&#32;on&#32;the&#32;ground&#32;-&#32;MSDN&#32;sends&#32;you&#32;back&#32;here,&#32;but&#32;the&#32;downloadable&#32;help&#32;file&#32;has&#32;no&#32;more&#32;info.&#32;Am&#32;I&#32;missing&#32;something&#63;&#32;Mark&#32;">
        
<p>thanks, although I'm a little confused as to what exactly you are suggesting I do. I don't think I can create only a custom lifetime manager, since I need to itercept resolve for every interface that derives from a base type.</p>
<p>The two things I can't do within my existing extension are</p>
<p>1) having created my object, store it in the container e.g. container.RegisterInstance(derivedType, createdInstance)</p>
<p>2) on the second request, retrieve it from the container container.Resolve(derivedType)</p>
<p>Documentation on Unity 2.0 extensions seems to be <a href="http://msdn.microsoft.com/en-us/library/ff660886%28v=PandP.20%29.aspx" rel="nofollow">
thin on the ground</a> - MSDN sends you back here, but the downloadable help file has no more info. Am I missing something?</p>
<p>Mark</p>

        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_529967" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="529990">
    <td id="PostDetailsCell_529990" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post529990"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/markheath">markheath</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="12/2/2010 10:49:01 AM" LocalTimeTicks="1291315741">Dec 2, 2010 at 10:49 AM</span></div>
            
        </div>
    </td>
    <td id="PostContent_529990" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post " 
        data-markdown="&#32;ok,&#32;I&#32;have&#32;a&#32;solution&#32;now&#32;but&#32;it&#32;includes&#32;a&#32;horrible&#32;hack&#32;to&#32;avoid&#32;a&#32;stack&#32;overflow&#32;exception&#58;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;public&#38;nbsp&#59;class&#38;nbsp&#59;CustomFactoryBuildStrategy&#38;nbsp&#59;&#58;&#38;nbsp&#59;BuilderStrategy&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;private&#38;nbsp&#59;ExtensionContext&#38;nbsp&#59;baseContext&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;private&#38;nbsp&#59;ICustomFactory&#38;nbsp&#59;factory&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;public&#38;nbsp&#59;CustomFactoryBuildStrategy&#40;ICustomFactory&#38;nbsp&#59;factory,&#38;nbsp&#59;ExtensionContext&#38;nbsp&#59;baseContext&#41;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;this.factory&#38;nbsp&#59;&#61;&#38;nbsp&#59;factory&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;this.baseContext&#38;nbsp&#59;&#61;&#38;nbsp&#59;baseContext&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;public&#38;nbsp&#59;override&#38;nbsp&#59;void&#38;nbsp&#59;PreBuildUp&#40;IBuilderContext&#38;nbsp&#59;context&#41;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;var&#38;nbsp&#59;key&#38;nbsp&#59;&#61;&#38;nbsp&#59;&#40;NamedTypeBuildKey&#41;context.OriginalBuildKey&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;if&#38;nbsp&#59;&#40;factory.CanCreate&#40;key.Type&#41;&#41;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;object&#38;nbsp&#59;existing&#38;nbsp&#59;&#61;&#38;nbsp&#59;GetExistingObject&#40;key.Type,&#38;nbsp&#59;context&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;if&#38;nbsp&#59;&#40;existing&#38;nbsp&#59;&#61;&#61;&#38;nbsp&#59;null&#41;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#47;&#47;&#38;nbsp&#59;create&#32;and&#32;cache&#32;it&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;context.Existing&#38;nbsp&#59;&#61;&#38;nbsp&#59;factory.Create&#40;key.Type&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#32;baseContext.Container.RegisterInstance&#40;type,&#38;nbsp&#59;existing,&#38;nbsp&#59;new&#38;nbsp&#59;ContainerControlledLifetimeManager&#40;&#41;&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;else&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;context.Existing&#38;nbsp&#59;&#61;&#38;nbsp&#59;existing&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;bool&#38;nbsp&#59;disableMe&#59;&#38;nbsp&#59;&#47;&#47;&#38;nbsp&#59;to&#38;nbsp&#59;avoid&#38;nbsp&#59;stack&#38;nbsp&#59;overflow&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;private&#38;nbsp&#59;object&#38;nbsp&#59;GetExistingObject&#40;Type&#38;nbsp&#59;type,&#38;nbsp&#59;IBuilderContext&#38;nbsp&#59;context&#41;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;if&#38;nbsp&#59;&#40;disableMe&#41;&#38;nbsp&#59;return&#38;nbsp&#59;null&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;IUnityContainer&#38;nbsp&#59;container&#38;nbsp&#59;&#61;&#38;nbsp&#59;context.NewBuildUp&#38;lt&#59;IUnityContainer&#38;gt&#59;&#40;&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;try&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;disableMe&#38;nbsp&#59;&#61;&#38;nbsp&#59;true&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;return&#38;nbsp&#59;container.Resolve&#40;type&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;finally&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;disableMe&#38;nbsp&#59;&#61;&#38;nbsp&#59;false&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#32;Surely&#32;there&#32;is&#32;a&#32;better&#32;way&#32;than&#32;this&#32;to&#32;implement&#32;GetExistingObject.&#32;I&#32;tried&#32;ExecuteBuildUp&#32;on&#32;the&#32;strategy&#32;chain,&#32;but&#32;that&#32;also&#32;results&#32;in&#32;stack&#32;overflow&#32;&#32;Mark&#32;">
        
<p>ok, I have a solution now but it includes a horrible hack to avoid a stack overflow exception:</p>
<pre style="font-family:consolas">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">public</span>&nbsp;<span style="color:blue">class</span>&nbsp;<span style="color:#2b91af">CustomFactoryBuildStrategy</span>&nbsp;:&nbsp;<span style="color:#2b91af">BuilderStrategy</span><br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">private</span>&nbsp;<span style="color:#2b91af">ExtensionContext</span>&nbsp;baseContext;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">private</span>&nbsp;<span style="color:#2b91af">ICustomFactory</span>&nbsp;factory;<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">public</span>&nbsp;CustomFactoryBuildStrategy(<span style="color:#2b91af">ICustomFactory</span>&nbsp;factory,&nbsp;<span style="color:#2b91af">ExtensionContext</span>&nbsp;baseContext)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">this</span>.factory&nbsp;=&nbsp;factory;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">this</span>.baseContext&nbsp;=&nbsp;baseContext;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">public</span>&nbsp;<span style="color:blue">override</span>&nbsp;<span style="color:blue">void</span>&nbsp;PreBuildUp(<span style="color:#2b91af">IBuilderContext</span>&nbsp;context)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">var</span>&nbsp;key&nbsp;=&nbsp;(<span style="color:#2b91af">NamedTypeBuildKey</span>)context.OriginalBuildKey;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">if</span>&nbsp;(factory.CanCreate(key.Type))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">object</span>&nbsp;existing&nbsp;=&nbsp;GetExistingObject(key.Type,&nbsp;context);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">if</span>&nbsp;(existing&nbsp;==&nbsp;<span style="color:blue">null</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green">//&nbsp;create and cache it</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.Existing&nbsp;=&nbsp;factory.Create(key.Type);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>                    baseContext.Container.RegisterInstance(type,&nbsp;existing,&nbsp;<span style="color:blue">new</span>&nbsp;<span style="color:#2b91af">ContainerControlledLifetimeManager</span>());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.Existing&nbsp;=&nbsp;existing;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">bool</span>&nbsp;disableMe;&nbsp;<span style="color:green">//&nbsp;to&nbsp;avoid&nbsp;stack&nbsp;overflow</span><br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">private</span>&nbsp;<span style="color:blue">object</span>&nbsp;GetExistingObject(<span style="color:#2b91af">Type</span>&nbsp;type,&nbsp;<span style="color:#2b91af">IBuilderContext</span>&nbsp;context)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">if</span>&nbsp;(disableMe)&nbsp;<span style="color:blue">return</span>&nbsp;<span style="color:blue">null</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af">IUnityContainer</span>&nbsp;container&nbsp;=&nbsp;context.NewBuildUp&lt;<span style="color:#2b91af">IUnityContainer</span>&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">try</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;disableMe&nbsp;=&nbsp;<span style="color:blue">true</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">return</span>&nbsp;container.Resolve(type);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">finally</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;disableMe&nbsp;=&nbsp;<span style="color:blue">false</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br></pre>
<p>Surely there is a better way than this to implement GetExistingObject. I tried ExecuteBuildUp on the strategy chain, but that also results in stack overflow<br>
<br>
Mark</p>

        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_529990" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="530358">
    <td id="PostDetailsCell_530358" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post530358"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/ctavares">ctavares</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="12/2/2010 9:44:40 PM" LocalTimeTicks="1291355080">Dec 2, 2010 at 9:44 PM</span></div>
            
        </div>
    </td>
    <td id="PostContent_530358" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post " 
        data-markdown="&#32;You&#39;re&#32;right,&#32;there&#39;s&#32;a&#32;much&#32;easier&#32;way&#32;to&#32;do&#32;this.&#32;You&#32;need&#32;to&#32;drop&#32;down&#32;further&#32;into&#32;the&#32;internals,&#32;though.&#32;You&#32;shouldn&#39;t&#32;need&#32;to&#32;implement&#32;GetExistingObject&#32;at&#32;all.&#32;The&#32;container&#32;will&#32;do&#32;the&#32;right&#32;thing&#32;for&#32;you.&#32;Look&#32;at&#32;what&#32;RegisterInstance&#32;is&#32;actually&#32;doing&#32;in&#32;the&#32;source&#32;code&#32;-&#32;it&#39;s&#32;taking&#32;the&#32;provided&#32;lifetime&#32;manager&#32;and&#32;putting&#32;it&#32;into&#32;the&#32;policy&#32;list.&#32;You&#32;can&#32;do&#32;exactly&#32;that&#32;yourself.&#32;Once&#32;it&#39;s&#32;in&#32;a&#32;lifetime&#32;manager,&#32;the&#32;container&#39;s&#32;standard&#32;lifetime&#32;logic&#32;is&#32;going&#32;to&#32;kick&#32;in,&#32;and&#32;your&#32;strategy&#32;&#40;which&#32;is&#32;in&#32;the&#32;pipeline&#32;after&#32;the&#32;Lifetime&#32;stage&#41;&#32;won&#39;t&#32;even&#32;be&#32;called&#32;-&#32;it&#32;got&#32;the&#32;object&#32;out&#32;of&#32;the&#32;lifetime&#32;manager&#32;and&#32;short-circuited&#32;the&#32;rest&#32;of&#32;the&#32;resolve&#32;logic.&#32;I&#32;haven&#39;t&#32;actually&#32;tried&#32;this,&#32;but&#32;code&#32;along&#32;these&#32;lines&#32;should&#32;do&#32;what&#32;you&#32;want&#58;&#32;&#32;&#32;&#32;public&#32;class&#32;CustomFactoryBuildStrategy&#32;&#58;&#32;BuilderStrategy&#32;&#123;&#32;public&#32;override&#32;void&#32;PreBuildUp&#40;IBuilderContext&#32;context&#41;&#32;&#123;&#32;var&#32;key&#32;&#61;&#32;&#40;NamedTypeBuildKey&#41;context.OriginalBuildKey&#59;&#32;if&#32;&#40;factory.CanCreate&#40;key.Type&#41;&#32;&#38;amp&#59;&#38;amp&#59;&#32;context.Existing&#32;&#61;&#61;&#32;null&#41;&#32;&#123;&#32;context.Existing&#32;&#61;&#32;factory.Create&#40;key.Type&#41;&#59;&#32;var&#32;ltm&#32;&#61;&#32;new&#32;ContainerControlledLifetimeManager&#40;&#41;&#59;&#32;ltm.SetValue&#40;context.Existing&#41;&#59;&#32;&#47;&#47;&#32;Add&#32;lifetime&#32;manager&#32;to&#32;container&#32;context.PersistentPolicies.Set&#38;lt&#59;ILifetimePolicy&#38;gt&#59;&#40;ltm,&#32;new&#32;NamedTypeBuildKey&#40;key.Type&#41;&#41;&#59;&#32;&#47;&#47;&#32;And&#32;add&#32;to&#32;LifetimeContainer&#32;so&#32;it&#32;gets&#32;disposed&#32;context.Lifetime.Add&#40;ltm&#41;&#59;&#32;&#47;&#47;&#32;Short&#32;circuit&#32;the&#32;rest&#32;of&#32;the&#32;chain,&#32;object&#39;s&#32;already&#32;created&#32;context.BuildComplete&#32;&#61;&#32;true&#59;&#32;&#125;&#32;&#125;&#32;&#125;&#32;&#32;&#32;&#32;Should&#32;do&#32;the&#32;same&#32;thing&#32;you&#32;were&#32;doing,&#32;or&#32;at&#32;least&#32;push&#32;you&#32;in&#32;the&#32;right&#32;direction.&#32;Hope&#32;this&#32;helps,&#32;&#38;nbsp&#59;&#32;-Chris&#32;&#38;nbsp&#59;&#32;&#38;nbsp&#59;&#32;">
        
<p>You're right, there's a much easier way to do this. You need to drop down further into the internals, though.</p>
<p>You shouldn't need to implement GetExistingObject at all. The container will do the right thing for you. Look at what RegisterInstance is actually doing in the source code - it's taking the provided lifetime manager and putting it into the policy list. You
 can do exactly that yourself. Once it's in a lifetime manager, the container's standard lifetime logic is going to kick in, and your strategy (which is in the pipeline after the Lifetime stage) won't even be called - it got the object out of the lifetime manager
 and short-circuited the rest of the resolve logic.</p>
<p>I haven't actually tried this, but code along these lines should do what you want:</p>
<p></p>
<div style="color:black; background-color:white">
<pre>    <span style="color:blue">public</span> <span style="color:blue">class</span> CustomFactoryBuildStrategy : BuilderStrategy
    {
        <span style="color:blue">public</span> <span style="color:blue">override</span> <span style="color:blue">void</span> PreBuildUp(IBuilderContext context)
        {
            <span style="color:blue">var</span> key = (NamedTypeBuildKey)context.OriginalBuildKey;
            
            <span style="color:blue">if</span> (factory.CanCreate(key.Type) &amp;&amp; context.Existing == <span style="color:blue">null</span>)
            {
                context.Existing = factory.Create(key.Type);
                <span style="color:blue">var</span> ltm = <span style="color:blue">new</span> ContainerControlledLifetimeManager();
                ltm.SetValue(context.Existing);

                <span style="color:green">// Add lifetime manager to container</span>
                context.PersistentPolicies.Set&lt;ILifetimePolicy&gt;(ltm, <span style="color:blue">new</span> NamedTypeBuildKey(key.Type));
                <span style="color:green">// And add to LifetimeContainer so it gets disposed</span>
                context.Lifetime.Add(ltm);

                <span style="color:green">// Short circuit the rest of the chain, object's already created</span>
                context.BuildComplete = <span style="color:blue">true</span>;
            }
        }
     }

</pre>
</div>
<p></p>
<p>Should do the same thing you were doing, or at least push you in the right direction. Hope this helps,</p>
<p>&nbsp;</p>
<p>-Chris</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_530358" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="530518">
    <td id="PostDetailsCell_530518" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post530518"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/markheath">markheath</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="12/3/2010 7:26:55 AM" LocalTimeTicks="1291390015">Dec 3, 2010 at 7:26 AM</span></div>
            
        </div>
    </td>
    <td id="PostContent_530518" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post " 
        data-markdown="&#32;thanks&#32;Chris,&#32;that&#32;is&#32;very&#32;helpful.&#32;I&#32;had&#32;downloaded&#32;the&#32;Unity&#32;code&#32;and&#32;was&#32;working&#32;through&#32;it,&#32;but&#32;there&#32;is&#32;a&#32;lot&#32;to&#32;get&#32;your&#32;head&#32;round&#32;in&#32;there.&#32;Your&#32;sample&#32;works&#32;perfectly,&#32;with&#32;one&#32;exception.&#32;We&#32;make&#32;a&#32;lot&#32;of&#32;use&#32;of&#32;Child&#32;containers&#32;&#40;sometimes&#32;three&#32;levels&#32;deep&#41;,&#32;and&#32;my&#32;original&#32;Unity&#32;1.2&#32;extension&#32;let&#32;you&#32;fall&#32;through&#32;to&#32;the&#32;parent&#32;container&#32;rather&#32;than&#32;having&#32;each&#32;child&#32;container&#32;cache&#32;a&#32;new&#32;instance.&#32;Here&#39;s&#32;my&#32;two&#32;failing&#32;unit&#32;tests&#32;to&#32;show&#32;what&#32;I&#32;am&#32;trying&#32;to&#32;achieve&#58;&#32;&#38;nbsp&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#91;Test&#93;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#91;Category&#40;&#38;quot&#59;AutomaticTest&#38;quot&#59;&#41;&#93;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;public&#38;nbsp&#59;void&#38;nbsp&#59;SameCreatedFromTwoChildContainers&#40;&#41;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;var&#38;nbsp&#59;child1&#38;nbsp&#59;&#61;&#38;nbsp&#59;container.CreateChildContainer&#40;&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;var&#38;nbsp&#59;one1&#38;nbsp&#59;&#61;&#38;nbsp&#59;child1.Resolve&#38;lt&#59;IOne&#38;gt&#59;&#40;&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;Assert.IsNotNull&#40;one1&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;AssertIsInstanceOf&#38;lt&#59;One&#38;gt&#59;&#40;one1&#41;&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;var&#38;nbsp&#59;child2&#38;nbsp&#59;&#61;&#38;nbsp&#59;container.CreateChildContainer&#40;&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;var&#38;nbsp&#59;one2&#38;nbsp&#59;&#61;&#38;nbsp&#59;child2.Resolve&#38;lt&#59;IOne&#38;gt&#59;&#40;&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;Assert.IsNotNull&#40;one2&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;AssertIsInstanceOf&#38;lt&#59;One&#38;gt&#59;&#40;one2&#41;&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;Assert.AreSame&#40;one1,&#38;nbsp&#59;one2&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#91;Test&#93;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#91;Category&#40;&#38;quot&#59;AutomaticTest&#38;quot&#59;&#41;&#93;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;public&#38;nbsp&#59;void&#38;nbsp&#59;WhenCreatedInChildUsesBaseCache&#40;&#41;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#123;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;var&#38;nbsp&#59;child&#38;nbsp&#59;&#61;&#38;nbsp&#59;container.CreateChildContainer&#40;&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;var&#38;nbsp&#59;one&#38;nbsp&#59;&#61;&#38;nbsp&#59;child.Resolve&#38;lt&#59;IOne&#38;gt&#59;&#40;&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;Assert.IsNotNull&#40;one&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;AssertIsInstanceOf&#38;lt&#59;One&#38;gt&#59;&#40;one&#41;&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;var&#38;nbsp&#59;oneBase&#38;nbsp&#59;&#61;&#38;nbsp&#59;container.Resolve&#38;lt&#59;IOne&#38;gt&#59;&#40;&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;Assert.IsNotNull&#40;oneBase&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;AssertIsInstanceOf&#38;lt&#59;One&#38;gt&#59;&#40;oneBase&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;Assert.AreSame&#40;one,&#38;nbsp&#59;oneBase&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#125;&#32;I&#32;tried&#32;to&#32;see&#32;if&#32;I&#32;could&#32;exclude&#32;my&#32;custom&#32;build&#32;strategy&#32;from&#32;child&#32;containers,&#32;but&#32;in&#32;the&#32;Context.ChildContainerCreated&#32;I&#32;couldn&#39;t&#32;see&#32;a&#32;way&#32;to&#32;remove&#32;a&#32;strategy&#32;from&#32;the&#32;e.ChildContext.Strategies&#32;collection.&#32;&#40;you&#32;can&#32;clear&#32;and&#32;re-add&#32;them&#32;all,&#32;but&#32;you&#32;need&#32;to&#32;know&#32;what&#32;build&#32;stage&#32;each&#32;one&#32;belongs&#32;to&#41;.&#32;Alternatively,&#32;my&#32;strategy&#32;could&#32;try&#32;to&#32;find&#32;its&#32;way&#32;to&#32;the&#32;root&#32;container&#39;s&#32;IBuilderContext&#32;and&#32;set&#32;the&#32;persistent&#32;policy&#32;there,&#32;but&#32;I&#32;haven&#39;t&#32;found&#32;a&#32;way&#32;to&#32;get&#32;to&#32;the&#32;parent&#32;IBuilderContext&#32;yet&#32;Anyway,&#32;sorry&#32;to&#32;keep&#32;pestering&#32;you,&#32;but&#32;any&#32;pointers&#32;in&#32;the&#32;right&#32;direction&#32;would&#32;be&#32;appreciated.&#32;Mark&#32;&#38;nbsp&#59;&#32;">
        
<p>thanks Chris,</p>
<p>that is very helpful. I had downloaded the Unity code and was working through it, but there is a lot to get your head round in there.</p>
<p>Your sample works perfectly, with one exception. We make a lot of use of Child containers (sometimes three levels deep), and my original Unity 1.2 extension let you fall through to the parent container rather than having each child container cache a new
 instance. Here's my two failing unit tests to show what I am trying to achieve:</p>
<p>&nbsp;</p>
<pre style="font-family:consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af">Test</span>]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af">Category</span>(<span style="color:#a31515">&quot;AutomaticTest&quot;</span>)]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">public</span>&nbsp;<span style="color:blue">void</span>&nbsp;SameCreatedFromTwoChildContainers()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">var</span>&nbsp;child1&nbsp;=&nbsp;container.CreateChildContainer();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">var</span>&nbsp;one1&nbsp;=&nbsp;child1.Resolve&lt;<span style="color:#2b91af">IOne</span>&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af">Assert</span>.IsNotNull(one1);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AssertIsInstanceOf&lt;<span style="color:#2b91af">One</span>&gt;(one1);<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">var</span>&nbsp;child2&nbsp;=&nbsp;container.CreateChildContainer();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">var</span>&nbsp;one2&nbsp;=&nbsp;child2.Resolve&lt;<span style="color:#2b91af">IOne</span>&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af">Assert</span>.IsNotNull(one2);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AssertIsInstanceOf&lt;<span style="color:#2b91af">One</span>&gt;(one2);<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af">Assert</span>.AreSame(one1,&nbsp;one2);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<pre style="font-family:consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af">Test</span>]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af">Category</span>(<span style="color:#a31515">&quot;AutomaticTest&quot;</span>)]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">public</span>&nbsp;<span style="color:blue">void</span>&nbsp;WhenCreatedInChildUsesBaseCache()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">var</span>&nbsp;child&nbsp;=&nbsp;container.CreateChildContainer();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">var</span>&nbsp;one&nbsp;=&nbsp;child.Resolve&lt;<span style="color:#2b91af">IOne</span>&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af">Assert</span>.IsNotNull(one);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AssertIsInstanceOf&lt;<span style="color:#2b91af">One</span>&gt;(one);<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue">var</span>&nbsp;oneBase&nbsp;=&nbsp;container.Resolve&lt;<span style="color:#2b91af">IOne</span>&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af">Assert</span>.IsNotNull(oneBase);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AssertIsInstanceOf&lt;<span style="color:#2b91af">One</span>&gt;(oneBase);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af">Assert</span>.AreSame(one,&nbsp;oneBase);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br></pre>
<p>I tried to see if I could exclude my custom build strategy from child containers, but in the Context.ChildContainerCreated I couldn't see a way to remove a strategy from the e.ChildContext.Strategies collection. (you can clear and re-add them all, but you
 need to know what build stage each one belongs to).</p>
<p>Alternatively, my strategy could try to find its way to the root container's IBuilderContext and set the persistent policy there, but I haven't found a way to get to the parent IBuilderContext yet</p>
<p>Anyway, sorry to keep pestering you, but any pointers in the right direction would be appreciated.</p>
<p>Mark</p>
<p>&nbsp;</p>

        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_530518" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="530895">
    <td id="PostDetailsCell_530895" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post530895"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/ctavares">ctavares</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="12/3/2010 8:45:08 PM" LocalTimeTicks="1291437908">Dec 3, 2010 at 8:45 PM</span></div>
            
        </div>
    </td>
    <td id="PostContent_530895" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post " 
        data-markdown="&#32;So&#32;is&#32;it&#32;safe&#32;to&#32;say&#32;you&#32;always&#32;want&#32;the&#32;caching&#32;to&#32;happen&#32;in&#32;the&#32;root&#32;container,&#32;or&#32;that&#32;you&#32;want&#32;the&#32;caching&#32;to&#32;happen&#32;in&#32;some&#32;parent&#32;container&#32;that&#32;may&#32;or&#32;may&#32;not&#32;be&#32;the&#32;root&#63;&#32;Policy&#32;lists&#32;have&#32;a&#32;hierarchical&#32;structure&#32;-&#32;each&#32;one&#32;has&#32;a&#32;parent.&#32;However&#32;you&#39;re&#32;right&#32;to&#32;be&#32;confused&#32;in&#32;that&#32;the&#32;structure&#32;isn&#39;t&#32;exposed&#32;directly&#32;to&#32;the&#32;users&#32;-&#32;there&#39;s&#32;no&#32;way&#32;to&#32;walk&#32;up&#32;to&#32;a&#32;policy&#32;list&#39;s&#32;parent.&#32;However,&#32;when&#32;you&#32;get&#32;a&#32;policy&#32;object&#32;from&#32;the&#32;policy&#32;list,&#32;you&#32;can&#32;find&#32;out&#32;which&#32;policy&#32;list&#32;it&#32;actually&#32;came&#32;from.&#32;This&#32;allows&#32;you&#32;to&#32;do&#32;a&#32;little&#32;bit&#32;of&#32;a&#32;cheat.&#32;Define&#32;a&#32;&#38;quot&#59;marker&#38;quot&#59;&#32;policy&#32;type.&#32;It&#39;ll&#32;also&#32;need&#32;to&#32;expose&#32;a&#32;LifetimeContainer&#32;&#40;you&#39;ll&#32;see&#32;why&#32;later&#41;.&#32;&#32;&#32;&#32;&#32;public&#32;class&#32;ParentMarkerPolicy&#32;&#58;&#32;IBuilderPolicy&#32;&#123;&#32;private&#32;ILifetimeContainer&#32;lifetime&#59;&#32;public&#32;ParentMarkerPolicy&#40;ILifetimeContainer&#32;lifetime&#41;&#32;&#123;&#32;this.lifetime&#32;&#61;&#32;lifetime&#59;&#32;&#125;&#32;public&#32;void&#32;AddToLifetime&#40;object&#32;o&#41;&#32;&#123;&#32;lifetime.Add&#40;o&#41;&#59;&#32;&#125;&#32;&#125;&#32;&#32;&#32;&#32;&#32;&#32;&#32;In&#32;your&#32;Initialize&#32;method&#32;for&#32;your&#32;extension,&#32;add&#32;this&#32;policy&#32;to&#32;your&#32;container.&#32;&#32;&#32;protected&#32;override&#32;void&#32;Initialize&#40;&#41;&#32;&#123;&#32;Context.Strategies.AddNew&#38;lt&#59;CustomStrategy&#38;gt&#59;&#40;UnityBuildStage.PreCreation&#41;&#59;&#32;Context.Policies.Set&#38;lt&#59;ParentMarkerPolicy&#38;gt&#59;&#40;new&#32;ParentMarkerPolicy&#40;Context.Lifetime&#41;,&#32;&#32;new&#32;NamedTypeBuildKey&#38;lt&#59;ParentMarkerPolicy&#38;gt&#59;&#40;&#41;&#41;&#59;&#32;&#125;&#32;&#32;&#32;&#32;Then,&#32;in&#32;your&#32;strategy,&#32;look&#32;for&#32;this&#32;marker&#32;policy.&#32;Use&#32;the&#32;source&#32;of&#32;that&#32;policy&#32;to&#32;store&#32;the&#32;new&#32;lifetime&#32;manager.&#32;&#32;&#32;if&#32;&#40;factory.CanCreate&#40;key.Type&#41;&#32;&#38;amp&#59;&#38;amp&#59;&#32;context.Existing&#32;&#61;&#61;&#32;null&#41;&#32;&#123;&#32;context.Existing&#32;&#61;&#32;factory.Create&#40;key.Type&#41;&#59;&#32;var&#32;ltm&#32;&#61;&#32;new&#32;ContainerControlledLifetimeManager&#40;&#41;&#59;&#32;ltm.SetValue&#40;context.Existing&#41;&#59;&#32;&#47;&#47;&#32;Find&#32;the&#32;container&#32;to&#32;add&#32;this&#32;to&#32;IPolicyList&#32;parentPolicies&#59;&#32;var&#32;parentMarker&#32;&#61;&#32;context.Policies.Get&#38;lt&#59;ParentMarkerPolicy&#38;gt&#59;&#40;new&#32;NamedTypeBuildKey&#38;lt&#59;ParentMarkerPolicy&#38;gt&#59;&#40;out&#32;parentPolicies&#41;&#41;&#59;&#32;&#47;&#47;&#32;TODO&#58;&#32;add&#32;error&#32;check&#32;-&#32;if&#32;policy&#32;is&#32;missing,&#32;extension&#32;is&#32;misconfigured&#32;&#47;&#47;&#32;Add&#32;lifetime&#32;manager&#32;to&#32;container&#32;parentPolicies.Set&#38;lt&#59;ILifetimePolicy&#38;gt&#59;&#40;ltm,&#32;new&#32;NamedTypeBuildKey&#40;key.Type&#41;&#41;&#59;&#32;&#47;&#47;&#32;And&#32;add&#32;to&#32;LifetimeContainer&#32;so&#32;it&#32;gets&#32;disposed&#32;parentMarker.AddToLifetime&#40;ltm&#41;&#59;&#32;&#47;&#47;&#32;Short&#32;circuit&#32;the&#32;rest&#32;of&#32;the&#32;chain,&#32;object&#39;s&#32;already&#32;created&#32;context.BuildComplete&#32;&#61;&#32;true&#59;&#32;&#125;&#32;&#32;&#32;&#32;That&#32;should&#32;do&#32;the&#32;trick.&#32;If&#32;you&#32;want&#32;to&#32;put&#32;the&#32;cached&#32;version&#32;somewhere&#32;else&#32;in&#32;the&#32;container&#32;hierarchy,&#32;you&#32;can&#32;do&#32;this&#32;-&#32;just&#32;add&#32;a&#32;new&#32;copy&#32;of&#32;the&#32;parent&#32;marker&#32;policy&#32;to&#32;the&#32;policy&#32;list&#32;in&#32;that&#32;container.&#32;The&#32;PolicyList&#32;always&#32;finds&#32;the&#32;policy&#32;that&#32;matches&#32;the&#32;type&#32;and&#32;key&#32;requested&#32;in&#32;the&#32;list&#32;closest&#32;to&#32;the&#32;one&#32;you&#39;re&#32;requesting&#32;from.&#32;Hope&#32;this&#32;helps,&#32;&#38;nbsp&#59;&#32;-Chris&#32;&#38;nbsp&#59;&#32;">
        
<p>So is it safe to say you always want the caching to happen in the root container, or that you want the caching to happen in some parent container that may or may not be the root?</p>
<p>Policy lists have a hierarchical structure - each one has a parent. However you're right to be confused in that the structure isn't exposed directly to the users - there's no way to walk up to a policy list's parent. However, when you get a policy object
 from the policy list, you can find out which policy list it actually came from.</p>
<p>This allows you to do a little bit of a cheat. Define a &quot;marker&quot; policy type. It'll also need to expose a LifetimeContainer (you'll see why later).</p>
<p></p>
<div style="color:black; background-color:white">
<pre><span style="color:blue"></span></pre>
<div style="color:black; background-color:white">
<pre><span style="color:blue">public</span> <span style="color:blue">class</span> ParentMarkerPolicy : IBuilderPolicy
{
    <span style="color:blue">private</span> ILifetimeContainer lifetime;

    <span style="color:blue">public</span> ParentMarkerPolicy(ILifetimeContainer lifetime)
    {
        <span style="color:blue">this</span>.lifetime = lifetime;
    }

    <span style="color:blue">public</span> <span style="color:blue">void</span> AddToLifetime(<span style="color:blue">object</span> o)
    {
        lifetime.Add(o);
    }
}

</pre>
</div>
<pre>
</pre>
</div>
<p></p>
<p>In your Initialize method for your extension, add this policy to your container.</p>
<p></p>
<div style="color:black; background-color:white">
<pre><span style="color:blue">protected</span> <span style="color:blue">override</span> <span style="color:blue">void</span> Initialize()
{
    Context.Strategies.AddNew&lt;CustomStrategy&gt;(UnityBuildStage.PreCreation);

    Context.Policies.Set&lt;ParentMarkerPolicy&gt;(<span style="color:blue">new</span> ParentMarkerPolicy(Context.Lifetime),</pre>
<pre>        <span style="color:blue">new</span> NamedTypeBuildKey&lt;ParentMarkerPolicy&gt;());
}
</pre>
</div>
<p></p>
<p>Then, in your strategy, look for this marker policy. Use the source of that policy to store the new lifetime manager.</p>
<p></p>
<div style="color:black; background-color:white">
<pre><span style="color:blue">if</span> (factory.CanCreate(key.Type) &amp;&amp; context.Existing == <span style="color:blue">null</span>)
{
    context.Existing = factory.Create(key.Type);
    <span style="color:blue">var</span> ltm = <span style="color:blue">new</span> ContainerControlledLifetimeManager();
    ltm.SetValue(context.Existing);

    <span style="color:green">// Find the container to add this to</span>
    IPolicyList parentPolicies;
    <span style="color:blue">var</span> parentMarker = context.Policies.Get&lt;ParentMarkerPolicy&gt;(<span style="color:blue">new</span> NamedTypeBuildKey&lt;ParentMarkerPolicy&gt;(<span style="color:blue">out</span> parentPolicies));

    <span style="color:green">// TODO: add error check - if policy is missing, extension is misconfigured</span>

    <span style="color:green">// Add lifetime manager to container</span>
    parentPolicies.Set&lt;ILifetimePolicy&gt;(ltm, <span style="color:blue">new</span> NamedTypeBuildKey(key.Type));
    <span style="color:green">// And add to LifetimeContainer so it gets disposed</span>
    parentMarker.AddToLifetime(ltm);

    <span style="color:green">// Short circuit the rest of the chain, object's already created</span>
    context.BuildComplete = <span style="color:blue">true</span>;
}

</pre>
</div>
<p></p>
<p>That should do the trick. If you want to put the cached version somewhere else in the container hierarchy, you can do this - just add a new copy of the parent marker policy to the policy list in that container. The PolicyList always finds the policy that
 matches the type and key requested in the list closest to the one you're requesting from.</p>
<p>Hope this helps,</p>
<p>&nbsp;</p>
<p>-Chris</p>
<p>&nbsp;</p>

        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_530895" class="Options" >
            
        </div>
        
    </td>
</tr>

        <tr><td colspan="3"><div class="PostSeparator"></div></td></tr>
        

<tr id="PostPanel" class="Post" d:forid="530921">
    <td id="PostDetailsCell_530921" style="vertical-align: top; border: solid #BBB 1px; border-bottom: none; border-left: none; border-top: none; width: 114px" class="Post">
        <div class="Details">
            <a name="post530921"></a>
            <div class="UserName" style="white-space: pre-wrap; word-wrap: break-word;"><a class="UserProfileLink" href="http://www.codeplex.com/site/users/view/markheath">markheath</a></div>
            <div class="UserRole"></div>
            <div style="white-space: normal" class="SubText"><span class="smartDate" title="12/3/2010 9:15:55 PM" LocalTimeTicks="1291439755">Dec 3, 2010 at 9:15 PM</span></div>
            
        </div>
    </td>
    <td id="PostContent_530921" style="width: 100%; vertical-align: top;" 
        class=" discussionPost discussionListContent WordWrapBreakWord Post " 
        data-markdown="&#32;thanks&#32;Chris,&#32;you&#32;have&#32;been&#32;so&#32;helpful&#32;and&#32;all&#32;my&#32;unit&#32;tests&#32;are&#32;passing&#32;now.&#32;There&#39;s&#32;one&#32;typo&#32;in&#32;your&#32;code,&#32;should&#32;be&#58;&#32;var&#38;nbsp&#59;parentMarker&#38;nbsp&#59;&#61;&#38;nbsp&#59;context.Policies.Get&#38;lt&#59;ParentMarkerPolicy&#38;gt&#59;&#40;new&#38;nbsp&#59;NamedTypeBuildKey&#38;lt&#59;ParentMarkerPolicy&#38;gt&#59;&#40;&#41;,&#38;nbsp&#59;out&#38;nbsp&#59;parentPolicies&#41;&#59;&#32;I&#32;also&#32;think&#32;this&#32;solution&#32;seems&#32;nicer&#32;than&#32;the&#32;approach&#32;taken&#32;by&#32;various&#32;AutoMockingContainer&#32;extensions&#32;I&#32;looked&#32;at&#32;while&#32;trying&#32;to&#32;solve&#32;this.&#32;I&#32;had&#32;been&#32;experimenting&#32;with&#32;InjectionFactory&#32;as&#32;a&#32;possible&#32;fallback&#32;if&#32;I&#32;couldn&#39;t&#32;get&#32;this&#32;working.&#32;With&#32;Unity&#32;2,&#32;it&#39;s&#32;really&#32;easy&#32;to&#32;set&#32;up,&#32;although&#32;I&#32;will&#32;stick&#32;with&#32;the&#32;extension&#32;as&#32;it&#32;means&#32;I&#32;don&#39;t&#32;need&#32;to&#32;know&#32;what&#32;assemblies&#32;the&#32;interfaces&#32;I&#32;want&#32;to&#32;resolve&#32;reside&#32;in&#58;&#32;foreach&#38;nbsp&#59;&#40;var&#38;nbsp&#59;type&#38;nbsp&#59;in&#38;nbsp&#59;this.GetType&#40;&#41;.Assembly.GetTypes&#40;&#41;&#41;&#123;&#32;if&#38;nbsp&#59;&#40;factory.CanCreate&#40;type&#41;&#41;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#123;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;container.RegisterType&#40;type,&#38;nbsp&#59;new&#38;nbsp&#59;ContainerControlledLifetimeManager&#40;&#41;,&#38;nbsp&#59;new&#38;nbsp&#59;InjectionFactory&#40;&#40;c,&#38;nbsp&#59;t,&#38;nbsp&#59;s&#41;&#38;nbsp&#59;&#61;&#38;gt&#59;&#38;nbsp&#59;factory.Create&#40;t&#41;&#41;&#41;&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#38;nbsp&#59;&#32;&#125;&#125;&#32;Mark&#32;">
        
<p>thanks Chris, you have been so helpful and all my unit tests are passing now. There's one typo in your code, should be:</p>
<pre style="font-family:consolas"><span style="color:blue">var</span>&nbsp;parentMarker&nbsp;=&nbsp;context.Policies.Get&lt;<span style="color:#2b91af">ParentMarkerPolicy</span>&gt;(<span style="color:blue">new</span>&nbsp;<span style="color:#2b91af">NamedTypeBuildKey</span>&lt;<span style="color:#2b91af">ParentMarkerPolicy</span>&gt;(),&nbsp;<span style="color:blue">out</span>&nbsp;parentPolicies);</pre>
<p>I also think this solution seems nicer than the approach taken by various AutoMockingContainer extensions I looked at while trying to solve this.</p>
<p>I had been experimenting with InjectionFactory as a possible fallback if I couldn't get this working. With Unity 2, it's really easy to set up, although I will stick with the extension as it means I don't need to know what assemblies the interfaces I want
 to resolve reside in:</p>
<pre style="font-family:consolas"><br><span style="color:blue">foreach</span>&nbsp;(<span style="color:blue">var</span>&nbsp;type&nbsp;<span style="color:blue">in</span>&nbsp;<span style="color:blue">this</span>.GetType().Assembly.GetTypes())<br>{<br>    <span style="color:blue">if</span>&nbsp;(factory.CanCreate(type))<br>&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;     <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; container.RegisterType(type,&nbsp;<span style="color:blue">new</span>&nbsp;<span style="color:#2b91af">ContainerControlledLifetimeManager</span>(),&nbsp;<span style="color:blue">new</span>&nbsp;<span style="color:#2b91af">InjectionFactory</span>((c,&nbsp;t,&nbsp;s)&nbsp;=&gt;&nbsp;factory.Create(t)));<br>&nbsp;&nbsp;&nbsp; }<br>}<br><br></pre>
<p>Mark</p>

        
    </td>
    <td style="vertical-align: top; width: 134px;" class="Post ">
        
        <div id="Options_530921" class="Options" >
            
        </div>
        
    </td>
</tr>

</table>
    </div>

    
        <div class="StandardMarginTop">
            <a id="SignInToAddCommentLink" href="https://www.codeplex.com/site/login?RedirectUrl=http%3a%2f%2funity.codeplex.com%2fdiscussions%2f236744">
                Sign in to post message or set email notifications
            </a>
        </div>
    


    <div id="PostEditorContainer">
        <a name="editor"></a>
        <div id="Editor" style="display: none;">
            

<div class="MarkdownEditor" data-options-id="5f6836a4-15f1-4dc3-a421-e23a102dfb11">
    <script class="options" defer="defer" id="5f6836a4-15f1-4dc3-a421-e23a102dfb11" type="application/json">{"maxLength":10000,"styleSheetLocation":""}</script>

    <div class="MarkdownEditorControls">
        <a href="#" tabindex="-1" class="control md_help" title="Markdown Syntax Guide"></a>
        <div class="control md_divider"></div>
        <a href="#" tabindex="-1" class="control md_header" title="Insert Header (CTRL + H)"></a>
        <a href="#" tabindex="-1" class="control md_code" title="Insert Code (CTRL + K)"></a>
        <a href="#" tabindex="-1" class="control md_quote" title="Insert Quote (CTRL + Q)"></a>
        <a href="#" tabindex="-1" class="control md_img" title="Insert Img (CTRL + G)"></a>
        <a href="#" tabindex="-1" class="control md_link" title="Insert Link (CTRL + L)"></a>
        <a href="#" tabindex="-1" class="control md_ulist" title="Unordered List (CTRL + U)"></a>
        <a href="#" tabindex="-1" class="control md_olist" title="Ordered List (CTRL + O)"></a>
        <a href="#" tabindex="-1" class="control md_italics" title="Italic Text (CTRL + I)"></a>
        <a href="#" tabindex="-1" class="control md_bold" title="Bold Text (CTRL + B)"></a>
    </div>

    

<div class="tab_control">
    <!-- Generate the basic HTML for the tabs. -->
    
        <div id="Compose"
              class="tab selected"
              data-custom-header-id=""
              data-tab-contents-id="compose_contents_ec3ad546-2589-45d1-80bc-15d008d8002f">
            Compose
        </div>
    
        <div id="Preview"
              class="tab "
              data-custom-header-id=""
              data-tab-contents-id="preview_contents_b80dd198-ea98-491e-a7f5-614b7dd87087">
            Preview
        </div>
    
    <div class="clear"></div>
</div>


    <div id="compose_contents_ec3ad546-2589-45d1-80bc-15d008d8002f" class="compose_tab_content">
        <textarea class=" MarkdownEditorDimensions" cols="20" id="MarkdownEditor" name="content" rows="2">
</textarea>
        <div class="ClearBoth"></div>

        <div class="markdownGuide" style="display: none">
            <table>
                <tr>
                    <td class="markdownGuideColumn">
                        <h1>Text Formatting</h1>
                        <div># Header 1</div>
                        <div>## Header 2</div>
                        <br />
                        <div>*italics* (or _italics_)</div>
                        <div>**bold** (or __bold__)</div>
                    </td>
                    <td class="markdownGuideColumn">
                        <h1>Lists</h1>
                        <div>* Unordered List</div>
                        <div>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp * SubItem</div>
                        <br />
                        <div>1. Ordered List</div>
                        <div>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp 1. SubItem</div>
                    </td>
                    <td class="markdownGuideColumn">
                        <h1>Quotes</h1>
                        <div>> Lorem ipsum</div>
                        <div>dolor sitamet </div>
                        <div>non. Lectus at</div>
                        <div>nam nunc...</div>
                    </td>
                    <td class="markdownGuideColumn">
                        <h1>Code</h1>
                        <div>`Inline Code`</div>
                        <br />
                        <div>``` C#</div>
                        <div>if (foo==bar)</div>
                        <div>&nbsp&nbsp&nbsp&nbsp&nbsp&nbspbar++</div>
                        <div>```</div>
                    </td>
                    <td class="markdownGuideColumn">
                        <h1>References</h1>
                        <div>[Link Text](URL)</div>
                        <br />
                        <div>![Image](URL)</div>
                        <br />
                        <a class="Reference" target="_blank" href="http://codeplex.codeplex.com/wikipage?title=Markdown&referringTitle=Documentation">Markdown Reference</a>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div id="preview_contents_b80dd198-ea98-491e-a7f5-614b7dd87087" class="preview_tab_content markDownOutput">
        
            <div></div>
        
    </div>
    <div class="clear"></div>
</div>

            
            <div class="row" id="recaptcha_row">
                
<script type="text/javascript">
    $(document).ready(function () {
        $('#recaptcha_reload').attr('src', '../assets/recaptcha_refresh.png');
        $('#recaptcha_switch_audio').attr('src', '../assets/recaptcha_audio.png');
        $('#recaptcha_switch_img').attr('src', '../assets/recaptcha_text.png');
        $('#recaptcha_whatsthis').attr('src', '../assets/recaptcha_help.png');
        $('#recaptcha_area tr:first').attr('height', '35');
    });
</script>

                <div class="clear"></div>
                <span id="ReCaptchaError"></span>
            </div>
            <div style="padding-top: 6px;">
                <input type="button" id="SaveButton" value="Save" class="ok" />
                <input type="button" id="CancelButton" value="Cancel" class="cancel" />
                <div class="clear"></div>
            </div>
        </div>
    </div>
</div>

<div id="DeletePostPanel" class="modal" style="display:none">
    <div class="row">
        <h2>Delete Post <a href="javascript:return false;" class="close">X</a></h2>
    </div>
    <div class="modal_info">
        <p>Are you sure you want to delete this post? You will not be able to recover it later.</p>
        <p class="modal_buttons">
            <input type="button" id="ClosePostCancel" value="Cancel" class="cancel" />
            <input type="button" id="ClosePostOk" value="Delete" class="ok" />
        </p>
        <div class="ClearBoth"></div>
    </div>
</div>
        
            <!-- Email notification / Subscription details -->
            
    </div>
</div>
    
<div id="DeleteThreadPanel" class="modal" style="display:none">
    <div class="row">
        <h2>Delete Thread <a href="javascript:return false;" class="close">X</a></h2>
    </div>
    <div class="modal_info">
        <p>Are you sure you want to delete this thread? You will not be able to recover it later.</p>
        <p class="modal_buttons">
            <input type="button" id="CloseThreadCancel" value="Cancel" class="cancel" />
            <input type="button" id="CloseThreadOk" value="Delete" class="ok" />
        </p>
        <div class="ClearBoth"></div>
    </div>
</div>

<script type="text/javascript" language="javascript">
    $(function () {

        $('#recaptcha_response_field')
            .bind('keypress', function (event) { return $submitKeyPressElement(this, event); });


        if ($('#DeleteThreadLink')) {
            $('#DeleteThreadLink').click(function () {
                OpenDialog('#DeleteThreadPanel', true, '41em');
            });
        }
        
        $('#DeleteThreadPanel #CloseThreadOk').click(function () {
            var url = 'http://unity.codeplex.com/discussions/236744';
            $.ajax({
                url: url,
                type: 'DELETE',
                success: function (x) {
                    location.href = x.RedirectUrl;
                }
            });
        });
    });

    workItemMention = new codeplex.ui.WorkItemMention();
    workItemMention.addLinks(".discussionPost");
</script>


        
        
                
                <div class="clear"></div>
                
                <div id="footer">
                    <div class="row">
                        <hr />
                        <ul>
                            <li>Â© 2006-2017 Microsoft</li>
                            <li><a href="http://www.codeplex.com/site/help">Get Help</a></li>
                            <li><a href="/site/legal/privacy">Privacy Statement</a></li>
                            <li><a href="http://www.codeplex.com/site/legal/terms">Terms of Use</a></li>
                            <li><a href="http://www.codeplex.com/site/legal/conduct">Code of Conduct</a></li>
                            <li><a href="http://developermedia.com/" target="_blank">Advertise With Us</a></li>
                            <li>Version 2017.10.3.21062</li>
                        </ul>
                    </div>
                </div>
            </div>
        </form>
    </body>

</html>